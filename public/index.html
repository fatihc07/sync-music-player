<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync Music Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aurora.js/0.4.2/aurora.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flac.js/0.3.0/flac.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .playlist-item {
            transition: all 0.3s ease;
        }
        .playlist-item:hover {
            transform: translateX(10px);
        }
        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .sortable-ghost {
            opacity: 0.4;
            background: rgba(255, 255, 255, 0.2) !important;
        }
        .sortable-drag {
            background: rgba(102, 126, 234, 0.8) !important;
        }
        .sortable-handle {
            cursor: grab;
        }
        .sortable-handle:active {
            cursor: grabbing;
        }
        
        /* Responsive dÃ¼zen iÃ§in ek stiller */
        @media (max-width: 768px) {
            .playlist-container {
                margin-top: 1rem;
            }
        }
        
        /* Ã‡alma listesi iÃ§in sabit yÃ¼kseklik */
        .playlist-container {
            height: calc(100% - 2rem);
            display: flex;
            flex-direction: column;
        }
        
        .playlist-scroll {
            flex-grow: 1;
            overflow-y: auto;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <h1 class="text-4xl font-bold text-center mb-8">ðŸŽµ Sync Music Player</h1>

        <!-- Oda OluÅŸturma BÃ¶lÃ¼mÃ¼ -->
        <div id="createJoinSection" class="glass-effect rounded-xl p-6 mb-6">
            <button onclick="createRoom()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center gap-2">
                <i class="fas fa-plus-circle"></i>
                Yeni Oda OluÅŸtur
            </button>
            <div id="roomLink" style="display: none;" class="mt-4 p-4 bg-white/10 rounded-lg"></div>
        </div>

        <!-- GiriÅŸ BÃ¶lÃ¼mÃ¼ -->
        <div id="loginSection" style="display: none;" class="glass-effect rounded-xl p-6 mb-6">
            <div class="flex gap-3">
                <input type="text" id="username" placeholder="KullanÄ±cÄ± adÄ±nÄ±z" 
                    class="flex-1 px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:border-indigo-500">
                <button onclick="login()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                    <i class="fas fa-sign-in-alt mr-2"></i>GiriÅŸ Yap
                </button>
            </div>
        </div>

        <!-- KullanÄ±cÄ±lar BÃ¶lÃ¼mÃ¼ -->
        <div id="userSection" class="glass-effect rounded-xl p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i class="fas fa-users"></i>
                    Odadaki KullanÄ±cÄ±lar
                </h3>
                <span id="userCount" class="bg-indigo-600 px-3 py-1 rounded-full text-sm">0 KullanÄ±cÄ±</span>
            </div>
            <div class="flex flex-wrap gap-2" id="userList"></div>
            <div class="mt-4 text-sm text-white/70 bg-white/10 p-3 rounded-lg">
                <p class="flex items-center gap-2"><i class="fas fa-info-circle"></i> Odadaki herkes ÅŸarkÄ± ekleyebilir ve Ã§alma listesini kontrol edebilir.</p>
            </div>
        </div>

        <!-- MÃ¼zik Ã‡alar BÃ¶lÃ¼mÃ¼ -->
        <div id="playerSection" style="display: none;" class="space-y-6">
            <!-- Ä°ki sÃ¼tunlu dÃ¼zen oluÅŸturalÄ±m -->
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Sol sÃ¼tun: Kontroller -->
                <div class="md:w-1/2">
                    <div class="glass-effect rounded-xl p-6">
                        <div class="flex flex-col items-center gap-4">
                            <div class="flex gap-2 w-full justify-center">
                                <button onclick="playMusic()" class="bg-green-600 hover:bg-green-700 text-white font-bold p-3 rounded-full transition duration-300">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button onclick="pauseMusic()" class="bg-red-600 hover:bg-red-700 text-white font-bold p-3 rounded-full transition duration-300">
                                    <i class="fas fa-pause"></i>
                                </button>
                            </div>
                            <div class="w-full">
                                <label class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition duration-300 flex items-center justify-center gap-2 w-full">
                                    <i class="fas fa-music mr-2"></i>
                                    ÅžarkÄ± Ekle
                                    <input type="file" id="localFile" accept=".mp3,.flac,.wav,audio/mp3,audio/flac,audio/wav" onchange="addLocalFile()" multiple class="hidden">
                                </label>
                                <p class="text-xs text-white/70 mt-2 text-center">Desteklenen formatlar: MP3, FLAC, WAV</p>
                                <p class="text-xs text-white/70 mt-1 text-center">EklediÄŸiniz ÅŸarkÄ±lar odadaki herkesle paylaÅŸÄ±lÄ±r</p>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <audio id="audioPlayer" class="w-full" controls></audio>
                        </div>
                    </div>
                </div>
                
                <!-- SaÄŸ sÃ¼tun: Ã‡alma Listesi -->
                <div class="md:w-1/2 playlist-container">
                    <div class="glass-effect rounded-xl p-6 h-full flex flex-col">
                        <h3 class="text-xl font-bold mb-4 flex items-center justify-between">
                            <span class="flex items-center gap-2">
                                <i class="fas fa-list"></i>
                                Ã‡alma Listesi
                            </span>
                            <span class="text-sm font-normal bg-white/10 px-3 py-1 rounded-lg">
                                Herkes ÅŸarkÄ± ekleyebilir
                            </span>
                        </h3>
                        <p class="text-sm text-white/70 mb-3">
                            <i class="fas fa-arrows-alt mr-1"></i> ÅžarkÄ±larÄ± sÃ¼rÃ¼kleyip bÄ±rakarak sÄ±ralamayÄ± deÄŸiÅŸtirebilirsiniz
                        </p>
                        <div class="playlist-scroll">
                            <ul id="playlist" class="space-y-2"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
    <script>
        const socket = io(window.location.origin);
        let username = '';
        let currentTrack = 0;
        let roomId = '';
        const audioPlayer = document.getElementById('audioPlayer');
        const playlist = document.getElementById('playlist');

        // Ã‡alma listesi yÃ¶netimi iÃ§in global deÄŸiÅŸkenler ekleyelim
        let currentPlaylist = [];
        let isPlaying = false;

        // Global deÄŸiÅŸkenlere ekleyelim
        let currentUsers = new Map();

        // URL'den room ID'yi al
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('room')) {
            roomId = urlParams.get('room');
            document.getElementById('createJoinSection').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
        }

        function createRoom() {
            socket.emit('createRoom');
        }

        socket.on('roomCreated', (newRoomId) => {
            roomId = newRoomId;
            const roomLink = `${window.location.origin}?room=${roomId}`;
            const roomLinkElement = document.getElementById('roomLink');
            roomLinkElement.innerHTML = `
                <div class="space-y-3">
                    <div class="flex items-center gap-2">
                        <span class="font-bold">Oda ID:</span>
                        <span class="bg-white/10 px-3 py-1 rounded">${roomId}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold">Oda Linki:</span>
                        <a href="${roomLink}" class="text-indigo-300 hover:text-indigo-400 break-all">${roomLink}</a>
                    </div>
                    <button onclick="copyLink()" class="bg-white/10 hover:bg-white/20 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center gap-2">
                        <i class="fas fa-copy"></i>
                        Linki Kopyala
                    </button>
                </div>
            `;
            roomLinkElement.style.display = 'block';
            document.getElementById('loginSection').style.display = 'block';
        });

        function login() {
            username = document.getElementById('username').value;
            if (username.trim() !== '') {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('createJoinSection').style.display = 'none';
                document.getElementById('playerSection').style.display = 'block';
                document.getElementById('userSection').style.display = 'block'; // KullanÄ±cÄ±lar bÃ¶lÃ¼mÃ¼nÃ¼ gÃ¶ster
                socket.emit('joinRoom', { roomId, username });
            }
        }

        function addLocalFile() {
            const files = document.getElementById('localFile').files;
            let filesAdded = 0;
            const totalFiles = files.length;
            
            for (let file of files) {
                if (file.size > 50 * 1024 * 1024) {
                    showError(`${file.name} dosyasÄ± Ã§ok bÃ¼yÃ¼k (Max: 50MB)`);
                    continue;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const song = {
                        name: file.name,
                        data: e.target.result,
                        addedBy: username
                    };
                    socket.emit('addSong', { roomId, song });
                    filesAdded++;

                    if (filesAdded === totalFiles) {
                        showSuccess(`${totalFiles} ÅŸarkÄ± baÅŸarÄ±yla eklendi`);
                    }
                };
                reader.onerror = function() {
                    showError(`${file.name} yÃ¼klenirken hata oluÅŸtu`);
                };
                reader.readAsDataURL(file);
            }
        }

        function playMusic() {
            socket.emit('play', { roomId, currentTime: audioPlayer.currentTime });
        }

        function pauseMusic() {
            socket.emit('pause', { roomId, currentTime: audioPlayer.currentTime });
        }

        function playSong(index) {
            if (index >= 0 && index < currentPlaylist.length) {
                currentTrack = index;
                socket.emit('playSong', { roomId, index });
            }
        }

        socket.on('updatePlaylist', (songs) => {
            currentPlaylist = songs;
            updatePlaylistUI();
            
            // EÄŸer hiÃ§ ÅŸarkÄ± Ã§almÄ±yorsa ve yeni ÅŸarkÄ± eklendiyse ilk ÅŸarkÄ±yÄ± Ã§al
            if (!isPlaying && songs.length > 0 && audioPlayer.paused) {
                playSong(songs.length - 1); // Son eklenen ÅŸarkÄ±yÄ± Ã§al
            }
        });

        socket.on('play', (currentTime) => {
            audioPlayer.currentTime = currentTime;
            audioPlayer.play().catch(error => {
                showError('ÅžarkÄ± Ã§alÄ±nÄ±rken hata: ' + error.message);
            });
            isPlaying = true;
            updatePlaylistUI();
        });

        socket.on('pause', (currentTime) => {
            audioPlayer.currentTime = currentTime;
            audioPlayer.pause();
            isPlaying = false;
            updatePlaylistUI();
        });

        socket.on('playSong', (data) => {
            currentTrack = data.index;
            
            audioPlayer.style.display = 'block';
            const container = audioPlayer.parentElement;
            
            // Varsa Ã¶nceki iframe'i kaldÄ±r
            const existingIframe = container.querySelector('iframe');
            if (existingIframe) {
                container.removeChild(existingIframe);
            }
            
            audioPlayer.src = data.song.data;
            audioPlayer.play().catch(error => {
                showError('ÅžarkÄ± Ã§alÄ±nÄ±rken hata: ' + error.message);
            });
            isPlaying = true;
            
            updatePlaylistUI();
            socket.emit('play', { roomId, currentTime: 0 });
        });

        socket.on('syncState', (state) => {
            isPlaying = state.isPlaying;
            if (state.isPlaying) {
                audioPlayer.currentTime = state.currentTime;
                audioPlayer.play().catch(error => {
                    showError('ÅžarkÄ± Ã§alÄ±nÄ±rken hata: ' + error.message);
                });
            } else {
                audioPlayer.currentTime = state.currentTime;
                audioPlayer.pause();
            }
            updatePlaylistUI();
        });

        // Ã‡alma listesi UI'Ä±nÄ± gÃ¼ncelleyen fonksiyon
        function updatePlaylistUI() {
            playlist.innerHTML = '';
            currentPlaylist.forEach((song, index) => {
                const li = document.createElement('li');
                li.className = `playlist-item p-3 rounded-lg flex items-center gap-2 ${
                    index === currentTrack ? 'bg-indigo-600' : 'bg-white/10 hover:bg-white/20'
                }`;
                li.dataset.index = index;
                
                // SÃ¼rÃ¼kle-bÄ±rak iÃ§in tutamaÃ§ ekleyelim
                const dragHandle = document.createElement('span');
                dragHandle.className = 'sortable-handle w-6 h-6 flex items-center justify-center rounded-full bg-white/10';
                dragHandle.innerHTML = '<i class="fas fa-grip-vertical"></i>';
                li.appendChild(dragHandle);
                
                // ÅžarkÄ± numarasÄ±
                const numberSpan = document.createElement('span');
                numberSpan.className = 'w-6 h-6 flex items-center justify-center rounded-full bg-white/10 text-xs';
                numberSpan.textContent = index + 1;
                li.appendChild(numberSpan);

                // ÅžarkÄ± adÄ± ve ekleyen kiÅŸi
                const nameContainer = document.createElement('div');
                nameContainer.className = 'flex-1 truncate';
                
                const nameSpan = document.createElement('div');
                nameSpan.className = 'font-medium flex items-center truncate';
                nameSpan.title = song.name; // Tam adÄ± tooltip olarak gÃ¶ster
                nameSpan.textContent = song.name;
                
                nameContainer.appendChild(nameSpan);
                
                // Ekleyen kiÅŸi bilgisi
                if (song.addedBy) {
                    const addedBySpan = document.createElement('div');
                    addedBySpan.className = 'text-xs text-white/70 mt-1 flex items-center gap-1 truncate';
                    addedBySpan.innerHTML = `<i class="fas fa-user-plus"></i> <span>Ekleyen: ${song.addedBy}</span>`;
                    nameContainer.appendChild(addedBySpan);
                }
                
                li.appendChild(nameContainer);

                // Butonlar iÃ§in container
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex items-center gap-1 shrink-0';

                // En Ãœste Al butonu
                if (index > 0) { // Ä°lk ÅŸarkÄ± zaten en Ã¼stte olduÄŸu iÃ§in ona buton eklemiyoruz
                    const moveTopButton = document.createElement('button');
                    moveTopButton.className = 'w-7 h-7 flex items-center justify-center rounded-full bg-blue-600 hover:bg-blue-700 text-white';
                    moveTopButton.innerHTML = '<i class="fas fa-arrow-up"></i>';
                    moveTopButton.title = 'En Ãœste Al';
                    moveTopButton.onclick = (e) => {
                        e.stopPropagation();
                        // ÅžarkÄ±yÄ± en Ã¼ste taÅŸÄ±
                        socket.emit('reorderPlaylist', {
                            roomId,
                            oldIndex: index,
                            newIndex: 0
                        });
                    };
                    buttonContainer.appendChild(moveTopButton);
                }

                // Oynat/Duraklat butonu
                const playButton = document.createElement('button');
                playButton.className = `w-7 h-7 flex items-center justify-center rounded-full ${
                    index === currentTrack && isPlaying ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'
                } text-white`;
                playButton.innerHTML = index === currentTrack && isPlaying ? 
                    '<i class="fas fa-pause"></i>' : 
                    '<i class="fas fa-play"></i>';
                playButton.onclick = (e) => {
                    e.stopPropagation();
                    playSong(index);
                };
                buttonContainer.appendChild(playButton);

                li.appendChild(buttonContainer);

                // TÄ±klama olayÄ±nÄ± sadece ÅŸarkÄ± adÄ±na ekleyelim
                nameContainer.onclick = (e) => {
                    e.stopPropagation();
                    playSong(index);
                };
                
                playlist.appendChild(li);
            });
            
            // Sortable.js ile sÃ¼rÃ¼kle-bÄ±rak Ã¶zelliÄŸini etkinleÅŸtirelim
            if (currentPlaylist.length > 1) {
                initSortable();
            }
        }
        
        // Sortable.js ile sÃ¼rÃ¼kle-bÄ±rak Ã¶zelliÄŸini baÅŸlatan fonksiyon
        function initSortable() {
            if (window.playlistSortable) {
                window.playlistSortable.destroy();
            }
            
            window.playlistSortable = new Sortable(playlist, {
                animation: 150,
                handle: '.sortable-handle',
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onEnd: function(evt) {
                    const oldIndex = evt.oldIndex;
                    const newIndex = evt.newIndex;
                    
                    if (oldIndex !== newIndex) {
                        // Server'a bildir
                        socket.emit('reorderPlaylist', {
                            roomId,
                            oldIndex,
                            newIndex
                        });
                    }
                }
            });
        }
        
        // Ã‡alan ÅŸarkÄ± deÄŸiÅŸtiÄŸinde UI'Ä± gÃ¼ncelle
        socket.on('currentTrackChanged', (index) => {
            currentTrack = index;
            updatePlaylistUI();
        });
        
        // ÅžarkÄ± sÄ±rasÄ± deÄŸiÅŸtirildiÄŸinde bildirim gÃ¶ster
        socket.on('playlistReordered', (data) => {
            if (data.username !== username) {
                showSuccess(`${data.username} "${data.songName}" ÅŸarkÄ±sÄ±nÄ±n sÄ±rasÄ±nÄ± deÄŸiÅŸtirdi`);
            }
        });

        // KullanÄ±cÄ± listesini gÃ¼ncelleyen fonksiyon
        function updateUsersUI(users) {
            const userList = document.getElementById('userList');
            const userCount = document.getElementById('userCount');
            
            userList.innerHTML = '';
            currentUsers.clear();
            
            users.forEach(user => {
                currentUsers.set(user.id, user.name);
                const userElement = document.createElement('div');
                userElement.className = `
                    flex items-center gap-2 px-3 py-2 rounded-lg
                    ${user.id === socket.id ? 'bg-indigo-600' : 'bg-white/10'}
                `;
                
                userElement.innerHTML = `
                    <i class="fas fa-user"></i>
                    <span>${user.name}</span>
                    ${user.id === socket.id ? '<span class="text-xs">(Sen)</span>' : ''}
                `;
                
                userList.appendChild(userElement);
            });
            
            userCount.textContent = `${users.length} KullanÄ±cÄ±`;
        }

        // Event listener'larÄ± ekleyelim
        socket.on('updateUsers', (users) => {
            updateUsersUI(users);
        });

        socket.on('userJoined', (user) => {
            if (user.id !== socket.id) {
                showSuccess(`${user.name} odaya katÄ±ldÄ±`);
            }
        });

        socket.on('userLeft', (user) => {
            showSuccess(`${user.name} odadan ayrÄ±ldÄ±`);
        });

        socket.on('songAdded', (data) => {
            if (data.addedBy !== username) {
                showSuccess(`${data.addedBy} "${data.songName}" ÅŸarkÄ±sÄ±nÄ± ekledi`);
            }
        });

        // Hata ve baÅŸarÄ± mesajlarÄ± iÃ§in yardÄ±mcÄ± fonksiyonlar
        function showError(message) {
            showNotification(message, 'error');
        }

        function showSuccess(message) {
            showNotification(message, 'success');
        }

        function showNotification(message, type) {
            const div = document.createElement('div');
            div.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'error' ? 'bg-red-600' : 'bg-green-600'
            } text-white`;
            div.textContent = message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        // Link kopyalama fonksiyonu
        function copyLink() {
            const roomLink = `${window.location.origin}?room=${roomId}`;
            navigator.clipboard.writeText(roomLink).then(() => {
                showSuccess('Link kopyalandÄ±!');
            }).catch(err => {
                showError('Link kopyalanamadÄ±');
                console.error('Link kopyalama hatasÄ±:', err);
            });
        }

        // Audio player hata yÃ¶netimi
        audioPlayer.addEventListener('error', (e) => {
            let errorMessage = 'Bilinmeyen bir hata oluÅŸtu';
            if (e.target.error) {
                switch (e.target.error.code) {
                    case e.target.error.MEDIA_ERR_ABORTED:
                        errorMessage = 'ÅžarkÄ± yÃ¼klemesi iptal edildi';
                        break;
                    case e.target.error.MEDIA_ERR_NETWORK:
                        errorMessage = 'AÄŸ hatasÄ± oluÅŸtu';
                        break;
                    case e.target.error.MEDIA_ERR_DECODE:
                        errorMessage = 'ÅžarkÄ± Ã§Ã¶zÃ¼mlenemedi';
                        break;
                    case e.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                        errorMessage = 'Bu ses formatÄ± desteklenmiyor';
                        break;
                }
            }
            showError(errorMessage);
        });

        // Oynatma durumu deÄŸiÅŸikliklerini izle
        audioPlayer.addEventListener('play', () => {
            if (!isPlaying) {
                playMusic();
            }
        });

        audioPlayer.addEventListener('pause', () => {
            if (isPlaying) {
                pauseMusic();
            }
        });

        // ÅžarkÄ± bittiÄŸinde sonraki ÅŸarkÄ±ya geÃ§
        audioPlayer.addEventListener('ended', () => {
            const nextTrack = currentTrack + 1;
            if (nextTrack < currentPlaylist.length) {
                playSong(nextTrack);
            } else if (currentPlaylist.length > 0) {
                // Ã‡alma listesi bitti, baÅŸa dÃ¶n
                playSong(0);
                showSuccess('Ã‡alma listesi baÅŸa dÃ¶ndÃ¼');
            } else {
                // Ã‡alma listesi boÅŸ
                isPlaying = false;
                updatePlaylistUI();
                showSuccess('Ã‡alma listesi tamamlandÄ±');
            }
        });
    </script>
</body>
</html>
