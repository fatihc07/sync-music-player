<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync Music Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aurora.js/0.4.2/aurora.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flac.js/0.3.0/flac.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .playlist-item {
            transition: all 0.3s ease;
        }
        .playlist-item:hover {
            transform: translateX(10px);
        }
        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(255, 255, 255, 0);
            }
        }
        
        .sortable-ghost {
            opacity: 0.4;
            background: rgba(255, 255, 255, 0.2) !important;
        }
        .sortable-drag {
            background: rgba(102, 126, 234, 0.8) !important;
        }
        .sortable-handle {
            cursor: grab;
        }
        .sortable-handle:active {
            cursor: grabbing;
        }
        
        /* Album cover styling */
        #albumCoverContainer {
            position: relative;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.5);
            transition: all 0.3s ease;
            border: 3px solid rgba(255, 255, 255, 0.2);
        }
        
        #albumCoverContainer::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 15px;
            height: 15px;
            background-color: #fff;
            border-radius: 50%;
            z-index: 2;
        }
        
        #albumCover {
            transition: all 0.3s ease;
        }
        
        .animate-pulse-slow #albumCover {
            animation: rotate 10s linear infinite;
        }
        
        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        /* Volume control styling */
        input[type=range] {
            -webkit-appearance: none;
            height: 7px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            background-image: linear-gradient(to right, #667eea 0%, #764ba2 100%);
            background-size: 70% 100%;
            background-repeat: no-repeat;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 15px;
            width: 15px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            box-shadow: 0 0 2px 0 #555;
            transition: background .3s ease-in-out;
        }
        
        input[type=range]::-webkit-slider-thumb:hover {
            background: #667eea;
        }
        
        input[type=range]::-webkit-slider-runnable-track {
            -webkit-appearance: none;
            box-shadow: none;
            border: none;
            background: transparent;
        }
        
        /* Responsive dÃ¼zen iÃ§in ek stiller */
        @media (max-width: 768px) {
            .playlist-container {
                margin-top: 1rem;
            }
        }
        
        /* Ã‡alma listesi iÃ§in sabit yÃ¼kseklik */
        .playlist-container {
            height: calc(100% - 2rem);
            display: flex;
            flex-direction: column;
        }
        
        .playlist-scroll {
            flex-grow: 1;
            overflow-y: auto;
            max-height: 400px; /* Sabit bir yÃ¼kseklik ekleyelim */
        }
        
        /* Ã‡alma listesi Ã¶ÄŸeleri arasÄ±ndaki boÅŸluk */
        #playlist > li {
            margin-bottom: 8px;
        }
        
        #playlist > li:last-child {
            margin-bottom: 0;
        }
        
        /* Uzun ÅŸarkÄ± isimleri iÃ§in ek stiller */
        .song-name-container {
            max-width: 100%;
            overflow: hidden;
        }
        
        .song-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            display: block;
        }
        
        /* Ã‡alma listesi Ã¶ÄŸelerinin geniÅŸliÄŸini artÄ±r */
        .playlist-item {
            min-width: 0; /* Flexbox iÃ§inde taÅŸmayÄ± Ã¶nlemek iÃ§in */
        }
        
        /* Åžu an Ã§alan ÅŸarkÄ± bilgisi iÃ§in taÅŸma kontrolÃ¼ */
        #currentSongName {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            padding: 0 8px;
        }
        
        /* Mobil gÃ¶rÃ¼nÃ¼m iÃ§in ek dÃ¼zenlemeler */
        @media (max-width: 640px) {
            .playlist-item .song-info {
                max-width: 180px;
            }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <h1 class="text-4xl font-bold text-center mb-8">ðŸŽµ Sync Music Player</h1>

        <!-- Oda Linki BÃ¶lÃ¼mÃ¼ - Her zaman Ã¼stte gÃ¶rÃ¼necek -->
        <div id="roomLinkSection" style="display: none;" class="glass-effect rounded-xl p-4 mb-6 sticky top-2 z-10">
            <div class="flex flex-col md:flex-row items-center justify-between gap-3">
                <div class="flex-1">
                    <div class="flex items-center gap-2">
                        <span class="font-bold whitespace-nowrap">Oda Linki:</span>
                        <span id="roomLinkText" class="bg-white/10 px-3 py-1 rounded text-indigo-300 truncate"></span>
                    </div>
                </div>
                <div class="flex gap-2 shrink-0">
                    <button onclick="copyLink()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center gap-2">
                        <i class="fas fa-copy"></i>
                        <span class="hidden md:inline">Linki Kopyala</span>
                    </button>
                    <button onclick="shareLink()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center gap-2">
                        <i class="fas fa-share-alt"></i>
                        <span class="hidden md:inline">PaylaÅŸ</span>
                    </button>
                    <button onclick="confirmDeleteRoom()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center gap-2">
                        <i class="fas fa-trash-alt"></i>
                        <span class="hidden md:inline">OdayÄ± Sil</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Oda OluÅŸturma BÃ¶lÃ¼mÃ¼ -->
        <div id="createJoinSection" class="glass-effect rounded-xl p-6 mb-6">
            <button onclick="createRoom()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center gap-2">
                <i class="fas fa-plus-circle"></i>
                Yeni Oda OluÅŸtur
            </button>
    </div>

        <!-- GiriÅŸ BÃ¶lÃ¼mÃ¼ -->
        <div id="loginSection" style="display: none;" class="glass-effect rounded-xl p-6 mb-6">
            <div class="flex gap-3">
                <input type="text" id="username" placeholder="KullanÄ±cÄ± adÄ±nÄ±z" 
                    class="flex-1 px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:border-indigo-500">
                <button onclick="login()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                    <i class="fas fa-sign-in-alt mr-2"></i>GiriÅŸ Yap
                </button>
            </div>
    </div>

        <!-- KullanÄ±cÄ±lar BÃ¶lÃ¼mÃ¼ -->
        <div id="userSection" class="glass-effect rounded-xl p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i class="fas fa-users"></i>
                    Odadaki KullanÄ±cÄ±lar
                </h3>
                <span id="userCount" class="bg-indigo-600 px-3 py-1 rounded-full text-sm">0 KullanÄ±cÄ±</span>
            </div>
            <div class="flex flex-wrap gap-2" id="userList"></div>
            <div class="mt-4 text-sm text-white/70 bg-white/10 p-3 rounded-lg">
                <p class="flex items-center gap-2"><i class="fas fa-sync-alt"></i> Odaya katÄ±ldÄ±ÄŸÄ±nÄ±zda, Ã§alan ÅŸarkÄ± otomatik olarak senkronize edilir.</p>
                <p class="flex items-center gap-2"><i class="fas fa-info-circle"></i> Odadaki herkes ÅŸarkÄ± ekleyebilir ve Ã§alma listesini kontrol edebilir.</p>
            </div>
        </div>
        
        <!-- MÃ¼zik Ã‡alar BÃ¶lÃ¼mÃ¼ -->
        <div id="playerSection" style="display: none;" class="space-y-6">
            <!-- Ä°ki sÃ¼tunlu dÃ¼zen oluÅŸturalÄ±m -->
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Sol sÃ¼tun: Kontroller -->
                <div class="md:w-1/2">
                    <div class="glass-effect rounded-xl p-6">
                        <div class="flex flex-col items-center gap-4">
                            <!-- ÅžarkÄ± kapaÄŸÄ± iÃ§in yuvarlak container ekle -->
                            <div id="albumCoverContainer" class="w-32 h-32 rounded-full bg-white/10 overflow-hidden flex items-center justify-center mb-2">
                                <img id="albumCover" src="https://cdn-icons-png.flaticon.com/512/3844/3844724.png" alt="Album Cover" class="w-full h-full object-cover">
                            </div>
                            
                            <!-- Åžu an Ã§alan ÅŸarkÄ± adÄ± -->
                            <div id="nowPlayingInfo" class="text-center w-full">
                                <p class="text-sm text-white/70">Åžu an Ã§alÄ±yor:</p>
                                <p id="currentSongName" class="font-bold truncate max-w-full">HenÃ¼z bir ÅŸarkÄ± seÃ§ilmedi</p>
                            </div>
                            
                            <div class="flex gap-2 w-full justify-center">
                                <button onclick="playAudio()" class="bg-green-600 hover:bg-green-700 text-white font-bold p-3 rounded-full transition duration-300">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button onclick="pauseAudio()" class="bg-red-600 hover:bg-red-700 text-white font-bold p-3 rounded-full transition duration-300">
                                    <i class="fas fa-pause"></i>
                                </button>
                            </div>
                            
                            <!-- Ses kontrolÃ¼ ekle -->
                            <div class="w-full">
                                <div class="flex items-center gap-2 mb-3">
                                    <i class="fas fa-volume-down text-white/70"></i>
                                    <input type="range" id="volumeControl" min="0" max="100" value="100" class="w-full h-2 bg-white/20 rounded-lg appearance-none cursor-pointer">
                                    <i class="fas fa-volume-up text-white/70"></i>
                                </div>
                            </div>
                            
                            <div class="w-full">
                                <label class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition duration-300 flex items-center justify-center gap-2 w-full">
                                    <i class="fas fa-music mr-2"></i>
                                    ÅžarkÄ± Ekle
                                    <input type="file" id="localFile" accept=".mp3,.flac,.wav,audio/mp3,audio/flac,audio/wav" onchange="addLocalFile()" multiple class="hidden">
                                </label>
                                <p class="text-xs text-white/70 mt-2 text-center">Desteklenen formatlar: MP3, FLAC, WAV</p>
                                <p class="text-xs text-white/70 mt-1 text-center">EklediÄŸiniz ÅŸarkÄ±lar odadaki herkesle paylaÅŸÄ±lÄ±r</p>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <audio id="audioPlayer" class="w-full" controls></audio>
                        </div>
                    </div>
                </div>
                
                <!-- SaÄŸ sÃ¼tun: Ã‡alma Listesi -->
                <div class="md:w-1/2 playlist-container">
                    <div class="glass-effect rounded-xl p-6 h-full flex flex-col">
                        <h3 class="text-xl font-bold mb-4 flex items-center justify-between">
                            <span class="flex items-center gap-2">
                                <i class="fas fa-list"></i>
                                Ã‡alma Listesi
                            </span>
                            <div class="flex items-center gap-2">
                                <button onclick="refreshPlaylist()" class="w-7 h-7 flex items-center justify-center rounded-full bg-indigo-600 hover:bg-indigo-700 text-white" title="Ã‡alma Listesini Yenile">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                                <span class="text-sm font-normal bg-white/10 px-3 py-1 rounded-lg">
                                    <span id="songCount">0</span> ÅžarkÄ±
                                </span>
                            </div>
                        </h3>
                        <p class="text-sm text-white/70 mb-3">
                            <i class="fas fa-arrows-alt mr-1"></i> ÅžarkÄ±larÄ± sÃ¼rÃ¼kleyip bÄ±rakarak sÄ±ralamayÄ± deÄŸiÅŸtirebilirsiniz
                        </p>
                        <div class="playlist-scroll">
                            <ul id="playlist" class="divide-y divide-white/10"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
    <script>
        // Socket.IO baÄŸlantÄ±sÄ±
        const socket = io(window.location.origin, {
            reconnectionAttempts: 10,
            timeout: 20000,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000
        });
        
        // Global deÄŸiÅŸkenler
        let username = '';
        let currentTrack = 0;
        let roomId = '';
        let currentPlaylist = [];
        let isPlaying = false;
        let currentUsers = new Map();
        let serverTimeOffset = 0;
        let syncInterval;
        let lastSyncTime = 0;
        let syncTolerance = 0.8; // Senkronizasyon toleransÄ±nÄ± artÄ±rdÄ±k (0.5 -> 0.8)
        let userInitiatedPlay = false; // KullanÄ±cÄ±nÄ±n baÅŸlattÄ±ÄŸÄ± Ã§alma durumu
        let syncRetryCount = 0; // Senkronizasyon yeniden deneme sayacÄ±
        let lastPlayedTrack = -1; // Son Ã§alÄ±nan ÅŸarkÄ± indeksi
        let isAudioLoaded = false;
        let isAudioBuffering = false;
        let pendingPlayRequest = false;
        let loadRetryCount = 0;
        let maxLoadRetries = 3;
        let isPlayInProgress = false;
        let bufferingTimeout = null;
        let isDownloadComplete = false;
        let pendingSyncTime = 0;
        let downloadStartTime = 0;
        
        const audioPlayer = document.getElementById('audioPlayer');
        const playlist = document.getElementById('playlist');
        const volumeControl = document.getElementById('volumeControl');
        const albumCover = document.getElementById('albumCover');
        const currentSongName = document.getElementById('currentSongName');

        // URL'den room ID'yi al
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('room')) {
            roomId = urlParams.get('room');
            const roomLink = `${window.location.origin}?room=${roomId}`;
            
            // Oda linkini Ã¼stteki bÃ¶lÃ¼mde gÃ¶ster
            document.getElementById('roomLinkText').textContent = roomLink;
            document.getElementById('roomLinkSection').style.display = 'block';
            document.getElementById('createJoinSection').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
            
            // Oturum bilgisini kontrol et
            checkSavedSession();
        }
        
        // Oda silme onay fonksiyonu
        function confirmDeleteRoom() {
            if (confirm('Bu odayÄ± silmek istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz ve tÃ¼m ÅŸarkÄ±lar silinecektir.')) {
                deleteRoom();
            }
        }
        
        // Oda silme fonksiyonu
        function deleteRoom() {
            socket.emit('deleteRoom', { roomId });
            showSuccess('Oda silme isteÄŸi gÃ¶nderildi...');
        }
        
        // Oda silindiÄŸinde
        socket.on('roomDeleted', (data) => {
            showError(data.message);
            
            // Oturum bilgisini temizle
            localStorage.removeItem('musicRoomSession');
            
            // 3 saniye sonra ana sayfaya yÃ¶nlendir
            setTimeout(() => {
                window.location.href = window.location.origin;
            }, 3000);
        });
        
        // Oturum bilgisini localStorage'a kaydet
        function saveSession() {
            if (roomId && username) {
                const sessionData = {
                    roomId,
                    username,
                    timestamp: Date.now(),
                    volume: volumeControl.value // Ses seviyesini de kaydet
                };
                localStorage.setItem('musicRoomSession', JSON.stringify(sessionData));
                console.log('Oturum bilgisi kaydedildi:', sessionData);
            }
        }
        
        // KaydedilmiÅŸ oturum bilgisini kontrol et
        function checkSavedSession() {
            const savedSession = localStorage.getItem('musicRoomSession');
            if (savedSession) {
                try {
                    const sessionData = JSON.parse(savedSession);
                    
                    // Oturum 7 gÃ¼nden eski mi kontrol et (1 hafta)
                    const sessionAge = Date.now() - sessionData.timestamp;
                    const oneWeekInMs = 7 * 24 * 60 * 60 * 1000;
                    
                    if (sessionAge < oneWeekInMs && sessionData.roomId === roomId) {
                        // KullanÄ±cÄ± adÄ±nÄ± giriÅŸ alanÄ±na yerleÅŸtir
                        document.getElementById('username').value = sessionData.username;
                        
                        // KaydedilmiÅŸ ses seviyesini ayarla
                        if (sessionData.volume) {
                            volumeControl.value = sessionData.volume;
                            audioPlayer.volume = sessionData.volume / 100;
                        }
                    }
                } catch (error) {
                    console.error('Oturum bilgisi okunamadÄ±:', error);
                    localStorage.removeItem('musicRoomSession');
                }
            }
        }
        
        // Sayfa yenilendiÄŸinde oturumu geri yÃ¼kle
        function restoreSession() {
            const savedSession = localStorage.getItem('musicRoomSession');
            if (savedSession && socket.connected) {
                try {
                    const sessionData = JSON.parse(savedSession);
                    
                    // Oturum 7 gÃ¼nden eski mi kontrol et
                    const sessionAge = Date.now() - sessionData.timestamp;
                    const oneWeekInMs = 7 * 24 * 60 * 60 * 1000;
                    
                    if (sessionAge < oneWeekInMs) {
                        // URL'deki oda ID'si ile kaydedilen oda ID'si aynÄ± mÄ± kontrol et
                        if (roomId && roomId === sessionData.roomId) {
                            username = sessionData.username;
                            
                            // Otomatik giriÅŸ yap
                            document.getElementById('loginSection').style.display = 'none';
                            document.getElementById('createJoinSection').style.display = 'none';
                            document.getElementById('playerSection').style.display = 'block';
                            document.getElementById('userSection').style.display = 'block';
                            
                            // Odaya katÄ±l
                            socket.emit('joinRoom', { roomId, username });
                            
                            // KaydedilmiÅŸ ses seviyesini ayarla
                            if (sessionData.volume) {
                                volumeControl.value = sessionData.volume;
                                audioPlayer.volume = sessionData.volume / 100;
                            }
                            
                            showSuccess('Oturumunuz geri yÃ¼klendi');
                            console.log('Oturum geri yÃ¼klendi:', sessionData);
                        }
                    } else {
                        // Oturum sÃ¼resi dolmuÅŸ, localStorage'dan kaldÄ±r
                        localStorage.removeItem('musicRoomSession');
                    }
                } catch (error) {
                    console.error('Oturum geri yÃ¼klenirken hata:', error);
                    localStorage.removeItem('musicRoomSession');
                }
            }
        }

        function createRoom() {
            console.log('Yeni oda oluÅŸturma isteÄŸi gÃ¶nderiliyor...');
            showNotification('Oda oluÅŸturuluyor...', 'info');
            
            // Sunucu baÄŸlantÄ±sÄ±nÄ± kontrol et
            if (!socket.connected) {
                console.error('Sunucu baÄŸlantÄ±sÄ± yok, yeniden baÄŸlanmaya Ã§alÄ±ÅŸÄ±lÄ±yor...');
                showError('Sunucu baÄŸlantÄ±sÄ± yok. LÃ¼tfen sayfayÄ± yenileyin.');
                socket.connect();
                return;
            }
            
            // Oda oluÅŸturma isteÄŸi gÃ¶nder
            socket.emit('createRoom', {}, (response) => {
                // Callback fonksiyonu ekledik
                if (response && response.error) {
                    console.error('Oda oluÅŸturma hatasÄ±:', response.error);
                    showError('Oda oluÅŸturulamadÄ±: ' + response.error);
                } else {
                    console.log('Oda oluÅŸturma isteÄŸi gÃ¶nderildi, yanÄ±t bekleniyor...');
                }
            });
            
            // 10 saniye iÃ§inde yanÄ±t gelmezse hata gÃ¶ster
            setTimeout(() => {
                if (!roomId) {
                    console.error('Oda oluÅŸturma zaman aÅŸÄ±mÄ±');
                    showError('Oda oluÅŸturma zaman aÅŸÄ±mÄ±na uÄŸradÄ±. LÃ¼tfen tekrar deneyin.');
                }
            }, 10000);
        }

        socket.on('roomCreated', (newRoomId) => {
            console.log('Oda baÅŸarÄ±yla oluÅŸturuldu:', newRoomId);
            roomId = newRoomId;
            const roomLink = `${window.location.origin}?room=${roomId}`;
            
            // Oda linkini Ã¼stteki bÃ¶lÃ¼mde gÃ¶ster
            document.getElementById('roomLinkText').textContent = roomLink;
            document.getElementById('roomLinkSection').style.display = 'block';
            document.getElementById('loginSection').style.display = 'block';
            
            // URL'yi gÃ¼ncelle (sayfa yenilenmeden)
            window.history.pushState({}, '', `?room=${roomId}`);
            
            // Oda oluÅŸturulduÄŸunda createJoinSection'Ä± gizle
            document.getElementById('createJoinSection').style.display = 'none';
            
            // BaÅŸarÄ± mesajÄ± gÃ¶ster
            showSuccess('Oda baÅŸarÄ±yla oluÅŸturuldu!');
        });

        function login() {
            username = document.getElementById('username').value;
            if (username.trim() !== '') {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('createJoinSection').style.display = 'none';
                document.getElementById('playerSection').style.display = 'block';
                document.getElementById('userSection').style.display = 'block'; // KullanÄ±cÄ±lar bÃ¶lÃ¼mÃ¼nÃ¼ gÃ¶ster
                
                // KullanÄ±cÄ± tarafÄ±ndan baÅŸlatÄ±ldÄ± olarak iÅŸaretle
                userInitiatedPlay = true;
                
                socket.emit('joinRoom', { roomId, username });
                
                // Oturum bilgisini kaydet
                saveSession();
            }
        }

        function addLocalFile() {
            const files = document.getElementById('localFile').files;
            let filesAdded = 0;
            const totalFiles = files.length;
            
            if (totalFiles === 0) {
                return;
            }
            
            showSuccess(`${totalFiles} ÅŸarkÄ± yÃ¼kleniyor...`);
            
            for (let file of files) {
                if (file.size > 50 * 1024 * 1024) {
                    showError(`${file.name} dosyasÄ± Ã§ok bÃ¼yÃ¼k (Max: 50MB)`);
                    continue;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const song = {
                        name: file.name,
                        data: e.target.result,
                        addedBy: username
                    };
                    socket.emit('addSong', { roomId, song });
                    filesAdded++;

                    if (filesAdded === totalFiles) {
                        showSuccess(`${totalFiles} ÅŸarkÄ± baÅŸarÄ±yla eklendi`);
                        // Dosya seÃ§iciyi sÄ±fÄ±rla
                        document.getElementById('localFile').value = '';
                    }
                };
                reader.onerror = function() {
                    showError(`${file.name} yÃ¼klenirken hata oluÅŸtu`);
                };
                reader.readAsDataURL(file);
            }
        }

        // ÅžarkÄ± yÃ¼kleme durumunu takip etmek iÃ§in deÄŸiÅŸkenler
        let isAudioLoaded = false;
        let isAudioBuffering = false;
        let pendingPlayRequest = false;
        let lastPlayedTrack = null;
        let loadRetryCount = 0;
        let maxLoadRetries = 3;
        let isPlayInProgress = false;
        let bufferingTimeout = null;
        
        // ÅžarkÄ± yÃ¼kleme durumunu gÃ¶steren element
        function showLoadingIndicator() {
            const container = document.getElementById('nowPlayingInfo');
            const existing = document.getElementById('loadingIndicator');
            if (!existing) {
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loadingIndicator';
                loadingDiv.className = 'text-sm text-white/70 mt-2';
                loadingDiv.innerHTML = '<i class="fas fa-cloud-download-alt"></i> ÅžarkÄ± indiriliyor...';
                container.appendChild(loadingDiv);
            }
        }
        
        function hideLoadingIndicator() {
            const indicator = document.getElementById('loadingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }
        
        // ÅžarkÄ± indirip Ã§almaya hazÄ±rlayan fonksiyon
        function downloadAndPrepareAudio(songUrl, syncTime) {
            return new Promise((resolve, reject) => {
                isDownloadComplete = false;
                downloadStartTime = Date.now();
                showLoadingIndicator();
                
                // Yeni bir Audio objesi oluÅŸtur
                const tempAudio = new Audio();
                
                // ÅžarkÄ± yÃ¼klendiÄŸinde
                tempAudio.addEventListener('canplaythrough', function onCanPlay() {
                    console.log('ÅžarkÄ± tamamen indirildi ve Ã§almaya hazÄ±r');
                    isDownloadComplete = true;
                    hideLoadingIndicator();
                    
                    // Event listener'Ä± kaldÄ±r
                    tempAudio.removeEventListener('canplaythrough', onCanPlay);
                    
                    // Ana audio player'a ÅŸarkÄ±yÄ± aktar
                    audioPlayer.src = songUrl;
                    
                    // ÅžarkÄ± pozisyonunu ayarla ve Ã§almaya hazÄ±r ol
                    audioPlayer.currentTime = syncTime;
                    
                    const downloadDuration = (Date.now() - downloadStartTime) / 1000;
                    console.log(`ÅžarkÄ± ${downloadDuration.toFixed(1)} saniyede indirildi`);
                    
                    showNotification(`ÅžarkÄ± indirildi, senkronize ediliyor...`, 'success');
                    resolve();
                });
                
                // Hata durumunda
                tempAudio.addEventListener('error', function onError(e) {
                    console.error('ÅžarkÄ± indirilirken hata:', e);
                    hideLoadingIndicator();
                    reject(e);
                });
                
                // ÅžarkÄ±yÄ± yÃ¼klemeye baÅŸla
                tempAudio.src = songUrl;
                tempAudio.load();
            });
        }
        
        // Sunucudan gelen senkronizasyon durumunu iÅŸle
        socket.on('syncState', async (state) => {
            console.log('Senkronizasyon durumu alÄ±ndÄ±:', state);
            
            if (!state.currentTrack !== undefined && state.currentTrack !== currentTrack) {
                // Yeni bir ÅŸarkÄ± Ã§alÄ±yor
                const song = currentPlaylist[state.currentTrack];
                if (song) {
                    try {
                        // Ã–nce ÅŸarkÄ±yÄ± indir ve hazÄ±rla
                        await downloadAndPrepareAudio(song.data, state.currentTime);
                        
                        currentTrack = state.currentTrack;
                        isPlaying = state.isPlaying;
                        
                        // ÅžarkÄ± Ã§alÄ±yorsa baÅŸlat
                        if (state.isPlaying) {
                            const playPromise = audioPlayer.play();
                            if (playPromise !== undefined) {
                                playPromise.then(() => {
                                    console.log('ÅžarkÄ± baÅŸarÄ±yla senkronize edildi ve Ã§alÄ±yor');
                                    startSyncInterval();
                                    showNotification('Odadaki ÅŸarkÄ±ya senkronize olundu', 'success');
                                }).catch(error => {
                                    console.error('Senkronizasyon sÄ±rasÄ±nda Ã§alma hatasÄ±:', error);
                                    if (error.name === 'NotAllowedError') {
                                        showNotification('ÅžarkÄ±yÄ± Ã§almak iÃ§in ekrana dokunun', 'info');
                                    }
                                });
                            }
                        }
                        
                        updatePlaylistUI();
                        updateNowPlayingInfo();
                        
                    } catch (error) {
                        console.error('ÅžarkÄ± indirme hatasÄ±:', error);
                        showError('ÅžarkÄ± indirilirken bir hata oluÅŸtu');
                    }
                }
            } else {
                // Sadece pozisyon senkronizasyonu
                if (isDownloadComplete) {
                    if (Math.abs(audioPlayer.currentTime - state.currentTime) > syncTolerance) {
                        audioPlayer.currentTime = state.currentTime;
                    }
                    
                    if (state.isPlaying !== isPlaying) {
                        if (state.isPlaying) {
                            audioPlayer.play().catch(error => {
                                console.error('Ã‡alma hatasÄ±:', error);
                            });
                        } else {
                            audioPlayer.pause();
                        }
                        isPlaying = state.isPlaying;
                    }
                } else {
                    // ÅžarkÄ± hala indiriliyor, senkronizasyon zamanÄ±nÄ± sakla
                    pendingSyncTime = state.currentTime;
                }
            }
        });

        function playAudio() {
            if (!roomId) return;
            
            if (!isAudioLoaded) {
                console.log('ÅžarkÄ± henÃ¼z yÃ¼klenmemiÅŸ, Ã§alma iÅŸlemi erteleniyor...');
                pendingPlayRequest = true;
                return;
            }
            
            userInitiatedPlay = true;
            
            safePlay().then(() => {
                // Sunucuya Ã§alma durumunu bildir
                socket.emit('play', {
                    roomId: roomId,
                    currentTime: audioPlayer.currentTime
                });
                
                // Son senkronizasyon zamanÄ±nÄ± kaydet
                lastSyncTime = Date.now();
                
                // Senkronizasyon interval'ini baÅŸlat
                startSyncInterval();
                
                // UI'Ä± gÃ¼ncelle
                updatePlaybackControls();
            }).catch(error => {
                console.error('KullanÄ±cÄ± tarafÄ±ndan baÅŸlatÄ±lan Ã§alma hatasÄ±:', error);
            });
        }
        
        // Duraklat dÃ¼ÄŸmesine tÄ±klandÄ±ÄŸÄ±nda
        function pauseAudio() {
            if (!roomId) return;
            
            safePause().then(() => {
                // Sunucuya duraklatma durumunu bildir
                socket.emit('pause', {
                    roomId: roomId,
                    currentTime: audioPlayer.currentTime
                });
                
                // Senkronizasyon interval'ini durdur
                stopSyncInterval();
                
                // UI'Ä± gÃ¼ncelle
                updatePlaybackControls();
            });
        }

        function playSong(index) {
            if (index >= 0 && index < currentPlaylist.length) {
            currentTrack = index;
            socket.emit('playSong', { roomId, index });
            }
        }
        
        // Ekle: Senkronizasyon isteÄŸi gÃ¶nderen fonksiyon
        function requestSync() {
            if (roomId && socket.connected) {
                socket.emit('requestSync', { roomId });
                console.log('Senkronizasyon isteÄŸi gÃ¶nderildi');
            }
        }
        
        // Ekle: Periyodik senkronizasyon baÅŸlat
        function startSyncInterval() {
            // Ã–nceki interval'i temizle
            if (syncInterval) {
                clearInterval(syncInterval);
            }
            
            // Her 3 saniyede bir senkronizasyon iste (5 saniyeden 3'e dÃ¼ÅŸÃ¼rdÃ¼k)
            syncInterval = setInterval(requestSync, 3000);
            console.log('Senkronizasyon interval baÅŸlatÄ±ldÄ± (3 saniye)');
        }
        
        // Ekle: Periyodik senkronizasyon durdur
        function stopSyncInterval() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
                console.log('Senkronizasyon interval durduruldu');
            }
        }

        socket.on('updatePlaylist', (songs) => {
            currentPlaylist = songs;
            updatePlaylistUI();
            
            // ÅžarkÄ± sayÄ±sÄ±nÄ± gÃ¼ncelle
            document.getElementById('songCount').textContent = songs.length;
            
            // Senkronizasyon iste
            requestSync();
        });

        socket.on('play', (data) => {
            isPlaying = true;
            const currentTime = typeof data === 'object' ? data.currentTime : data;
            const trackIndex = typeof data === 'object' && data.currentTrack !== undefined ? data.currentTrack : currentTrack;
            
            // EÄŸer ÅŸarkÄ± indeksi deÄŸiÅŸtiyse, ÅŸarkÄ±yÄ± deÄŸiÅŸtir
            if (trackIndex !== currentTrack && trackIndex !== undefined) {
                currentTrack = trackIndex;
                // ÅžarkÄ± deÄŸiÅŸikliÄŸi iÅŸlemi burada yapÄ±lacak
                // Bu durumda playSong eventi zaten tetiklenecektir
                return;
            }
            
            if (!isAudioLoaded) {
                console.log('ÅžarkÄ± henÃ¼z yÃ¼klenmemiÅŸ, Ã§alma iÅŸlemi erteleniyor...');
                pendingPlayRequest = true;
                return;
            }
            
            // ÅžarkÄ± pozisyonunu ayarla
            audioPlayer.currentTime = currentTime;
            
            // ÅžarkÄ±yÄ± Ã§al
            safePlay().then(() => {
                // Son senkronizasyon zamanÄ±nÄ± kaydet
                lastSyncTime = Date.now();
                
                // Senkronizasyon interval'ini baÅŸlat
                startSyncInterval();
                
                // UI'Ä± gÃ¼ncelle
                updatePlaybackControls();
            }).catch(error => {
                console.error('Sunucudan gelen Ã§alma komutu iÅŸlenirken hata:', error);
            });
        });

        socket.on('pause', (data) => {
            isPlaying = false;
            const currentTime = typeof data === 'object' ? data.currentTime : data;
            
            // ÅžarkÄ± pozisyonunu ayarla
            audioPlayer.currentTime = currentTime;
            
            // ÅžarkÄ±yÄ± duraklat
            safePause().then(() => {
                // Senkronizasyon interval'ini durdur
                stopSyncInterval();
                
                // UI'Ä± gÃ¼ncelle
                updatePlaybackControls();
            });
        });

        socket.on('syncPlayback', (data) => {
            // Son senkronizasyon zamanÄ±nÄ± kaydet
            lastSyncTime = Date.now();
            
            // Sunucu zaman farkÄ±nÄ± gÃ¼ncelle
            if (data.serverTime) {
                serverTimeOffset = Date.now() - data.serverTime;
            }
            
            // ÅžarkÄ± deÄŸiÅŸmiÅŸse, yeni ÅŸarkÄ±ya geÃ§
            if (data.currentTrack !== undefined && data.currentTrack !== currentTrack) {
                console.log(`ÅžarkÄ± deÄŸiÅŸti: ${currentTrack} -> ${data.currentTrack}`);
                playSong(data.currentTrack);
                return;
            }
            
            // ÅžarkÄ± yÃ¼klenmemiÅŸse senkronizasyonu ertele
            if (!isAudioLoaded) {
                console.log('ÅžarkÄ± henÃ¼z yÃ¼klenmemiÅŸ, senkronizasyon erteleniyor...');
                return;
            }
            
            // Ã‡alma durumu deÄŸiÅŸtiyse gÃ¼ncelle
            if (data.isPlaying !== undefined && data.isPlaying !== isPlaying) {
                console.log(`Ã‡alma durumu deÄŸiÅŸti: ${isPlaying} -> ${data.isPlaying}`);
                
                if (data.isPlaying) {
                    // ÅžarkÄ±yÄ± Ã§al
                    audioPlayer.currentTime = data.currentTime;
                    userInitiatedPlay = true; // KullanÄ±cÄ± tarafÄ±ndan baÅŸlatÄ±ldÄ± olarak iÅŸaretle
                    
                    const playPromise = audioPlayer.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log('ÅžarkÄ± baÅŸarÄ±yla Ã§alÄ±nmaya baÅŸladÄ± (senkronizasyon)');
                            isPlaying = true;
                            
                            // UI'Ä± gÃ¼ncelle
                            updatePlaylistUI();
                            updateNowPlayingInfo();
                        }).catch(error => {
                            console.error('Senkronizasyon sÄ±rasÄ±nda Ã§alma hatasÄ±:', error);
                            
                            // Otomatik Ã§alma engellendiyse kullanÄ±cÄ±ya bildir
                            if (error.name === 'NotAllowedError') {
                                showNotification('Otomatik Ã§alma engellendi. LÃ¼tfen Ã§alma dÃ¼ÄŸmesine tÄ±klayÄ±n.', 'info');
                                userInitiatedPlay = false;
                            }
                        });
                    }
                    
                    // Senkronizasyon interval'ini baÅŸlat
                    startSyncInterval();
                } else {
                    // ÅžarkÄ±yÄ± duraklat
                    audioPlayer.pause();
                    audioPlayer.currentTime = data.currentTime;
                    isPlaying = false;
                    
                    // Senkronizasyon interval'ini durdur
                    stopSyncInterval();
                }
                
                // UI'Ä± gÃ¼ncelle
                updatePlaylistUI();
                updateNowPlayingInfo();
                return;
            }
            
            // Ã‡alma durumunu kontrol et
            if (isPlaying && !audioPlayer.paused && data.isPlaying) {
                // Mevcut pozisyon ile sunucudan gelen pozisyon arasÄ±ndaki farkÄ± hesapla
                const currentDiff = Math.abs(audioPlayer.currentTime - data.currentTime);
                
                // EÄŸer fark tolerans deÄŸerinden fazlaysa senkronize et
                if (currentDiff > syncTolerance) {
                    console.log(`ÅžarkÄ± senkronize ediliyor: ${audioPlayer.currentTime.toFixed(2)}s -> ${data.currentTime.toFixed(2)}s (Fark: ${currentDiff.toFixed(2)}s)`);
                    
                    // ÅžarkÄ± pozisyonunu ayarla
                    audioPlayer.currentTime = data.currentTime;
                    
                    // Fark Ã§ok bÃ¼yÃ¼kse bildirim gÃ¶ster
                    if (currentDiff > 5) {
                        showNotification(`ÅžarkÄ± senkronize edildi (${currentDiff.toFixed(1)} saniye fark)`, 'info');
                    }
                }
            }
        });

        socket.on('syncState', (state) => {
            console.log('Sunucudan senkronizasyon durumu alÄ±ndÄ±:', state);
            
            isPlaying = state.isPlaying;
            currentTrack = state.currentTrack;
            
            // Sunucu zaman farkÄ±nÄ± gÃ¼ncelle
            if (state.serverTime) {
                serverTimeOffset = Date.now() - state.serverTime;
            }
            
            // ÅžarkÄ± deÄŸiÅŸmiÅŸse yeni ÅŸarkÄ±yÄ± yÃ¼kle
            if (currentTrack !== lastPlayedTrack && state.currentTrack !== undefined) {
                lastPlayedTrack = currentTrack;
                
                // ÅžarkÄ± URL'sini al
                const songUrl = currentPlaylist[currentTrack]?.data;
                if (songUrl) {
                    console.log(`Yeni ÅŸarkÄ± yÃ¼kleniyor: ${currentPlaylist[currentTrack].name}`);
                    
                    // Ã–nce mevcut ÅŸarkÄ±yÄ± duraklat
                    safePause().then(() => {
                        // ÅžarkÄ±yÄ± yÃ¼kle
                        audioPlayer.src = songUrl;
                        isAudioLoaded = false;
                        loadRetryCount = 0;
                        
                        // ÅžarkÄ± yÃ¼klendiÄŸinde
                        audioPlayer.oncanplay = function() {
                            isAudioLoaded = true;
                            console.log(`ÅžarkÄ± yÃ¼klendi: ${currentPlaylist[currentTrack].name}`);
                            
                            // ÅžarkÄ± pozisyonunu ayarla
                            audioPlayer.currentTime = state.currentTime;
                            
                            // EÄŸer ÅŸarkÄ± Ã§alÄ±yorsa otomatik baÅŸlat
                            if (state.isPlaying) {
                                console.log(`Odada Ã§alan ÅŸarkÄ± senkronize ediliyor: ${state.currentTime.toFixed(2)} saniyeden baÅŸlatÄ±lÄ±yor`);
                                userInitiatedPlay = true;
                                
                                // Mobil cihazlarda otomatik Ã§alma sorunlarÄ±nÄ± Ã¶nlemek iÃ§in
                                // KÄ±sa bir gecikme ekleyelim
                                setTimeout(() => {
                                    safePlay().then(() => {
                                        console.log('Senkronizasyon baÅŸarÄ±lÄ±, ÅŸarkÄ± Ã§alÄ±yor');
                                        
                                        // Senkronizasyon interval'ini baÅŸlat
                                        startSyncInterval();
                                        
                                        // Son senkronizasyon zamanÄ±nÄ± kaydet
                                        lastSyncTime = Date.now();
                                        
                                        // KullanÄ±cÄ±ya bilgi ver
                                        showNotification('Odada Ã§alan ÅŸarkÄ±ya senkronize olundu', 'success');
                                    }).catch(error => {
                                        console.error('Senkronizasyon sÄ±rasÄ±nda ÅŸarkÄ± Ã§alma hatasÄ±:', error);
                                        showNotification('ÅžarkÄ±yÄ± Ã§almak iÃ§in ekrana dokunun', 'info');
                                    });
                                }, 300);
                            }
                            
                            // Bekleyen Ã§alma isteÄŸi varsa iÅŸle
                            if (pendingPlayRequest) {
                                pendingPlayRequest = false;
                                setTimeout(() => {
                                    safePlay().catch(error => {
                                        console.error('Bekleyen Ã§alma isteÄŸi iÅŸlenirken hata:', error);
                                    });
                                }, 300);
                            }
                        };
                        
                        // ÅžarkÄ± yÃ¼klenirken hata olursa
                        audioPlayer.onerror = function(e) {
                            console.error('ÅžarkÄ± yÃ¼klenirken hata:', e);
                            
                            if (loadRetryCount < maxLoadRetries) {
                                loadRetryCount++;
                                console.log(`ÅžarkÄ± yÃ¼kleme yeniden deneniyor (${loadRetryCount}/${maxLoadRetries})...`);
                                
                                // 1 saniye bekleyip yeniden dene
                                setTimeout(() => {
                                    audioPlayer.src = songUrl;
                                    audioPlayer.load();
                                }, 1000);
                            } else {
                                showError(`ÅžarkÄ± yÃ¼klenemedi: ${currentPlaylist[currentTrack].name}`);
                            }
                        };
                    });
                }
            } else {
                // ÅžarkÄ± deÄŸiÅŸmediyse sadece pozisyonu gÃ¼ncelle
                audioPlayer.currentTime = state.currentTime;
            }
            
            // ÅžarkÄ± Ã§alÄ±yorsa ve yÃ¼klendiyse
            if (state.isPlaying && isAudioLoaded) {
                // ÅžarkÄ± pozisyonlarÄ± arasÄ±ndaki fark tolerans deÄŸerinden bÃ¼yÃ¼kse senkronize et
                const timeDiff = Math.abs(audioPlayer.currentTime - state.currentTime);
                if (timeDiff > syncTolerance) {
                    console.log(`ÅžarkÄ± pozisyonu senkronize ediliyor: ${audioPlayer.currentTime.toFixed(2)}s -> ${state.currentTime.toFixed(2)}s`);
                    audioPlayer.currentTime = state.currentTime;
                }
                
                // ÅžarkÄ± Ã§almÄ±yorsa baÅŸlat
                if (audioPlayer.paused) {
                    console.log('ÅžarkÄ± duraklatÄ±lmÄ±ÅŸ, Ã§almaya devam ediliyor');
                    userInitiatedPlay = true;
                    
                    // Mobil cihazlarda otomatik Ã§alma sorunlarÄ±nÄ± Ã¶nlemek iÃ§in
                    // KÄ±sa bir gecikme ekleyelim
                    setTimeout(() => {
                        safePlay().then(() => {
                            // Senkronizasyon interval'ini baÅŸlat
                            startSyncInterval();
                        }).catch(error => {
                            console.error('ÅžarkÄ± Ã§alma hatasÄ±:', error);
                            showNotification('ÅžarkÄ±yÄ± Ã§almak iÃ§in ekrana dokunun', 'info');
                        });
                    }, 300);
                }
            } else if (!state.isPlaying && !audioPlayer.paused) {
                // ÅžarkÄ± Ã§almÄ±yorsa duraklat
                console.log('ÅžarkÄ± duraklatÄ±lÄ±yor');
                safePause().then(() => {
                    // Senkronizasyon interval'ini durdur
                    stopSyncInterval();
                });
            }
            
            // UI'Ä± gÃ¼ncelle
            updatePlaylistUI();
            updateNowPlayingInfo();
        });

        // Ã‡alma listesi UI'Ä±nÄ± gÃ¼ncelleyen fonksiyon
        function updatePlaylistUI() {
            playlist.innerHTML = '';
            
            // Ã‡alma listesi boÅŸsa bir mesaj gÃ¶ster
            if (currentPlaylist.length === 0) {
                const emptyMessage = document.createElement('li');
                emptyMessage.className = 'p-4 text-center text-white/50';
                emptyMessage.innerHTML = '<i class="fas fa-music mr-2"></i> HenÃ¼z ÅŸarkÄ± eklenmemiÅŸ';
                playlist.appendChild(emptyMessage);
                document.getElementById('songCount').textContent = '0';
                return;
            }
            
            // ÅžarkÄ± sayÄ±sÄ±nÄ± gÃ¼ncelle
            document.getElementById('songCount').textContent = currentPlaylist.length;
            
            // Her ÅŸarkÄ± iÃ§in bir liste Ã¶ÄŸesi oluÅŸtur
            currentPlaylist.forEach((song, index) => {
                const li = document.createElement('li');
                li.className = `playlist-item p-3 rounded-lg flex items-center gap-2 ${
                    index === currentTrack ? 'bg-indigo-600' : 'bg-white/10 hover:bg-white/20'
                }`;
                li.dataset.index = index;
                
                // SÃ¼rÃ¼kle-bÄ±rak iÃ§in tutamaÃ§ ekleyelim
                const dragHandle = document.createElement('span');
                dragHandle.className = 'sortable-handle w-6 h-6 flex items-center justify-center rounded-full bg-white/10 shrink-0';
                dragHandle.innerHTML = '<i class="fas fa-grip-vertical"></i>';
                li.appendChild(dragHandle);
                
                // ÅžarkÄ± numarasÄ±
                const numberSpan = document.createElement('span');
                numberSpan.className = 'w-6 h-6 flex items-center justify-center rounded-full bg-white/10 text-xs shrink-0';
                numberSpan.textContent = index + 1;
                li.appendChild(numberSpan);

                // ÅžarkÄ± adÄ± ve ekleyen kiÅŸi
                const nameContainer = document.createElement('div');
                nameContainer.className = 'flex-1 min-w-0'; // min-width: 0 ekleyerek taÅŸmayÄ± Ã¶nlÃ¼yoruz
                
                const nameSpan = document.createElement('div');
                nameSpan.className = 'font-medium flex items-center';
                nameSpan.title = song.name; // Tam adÄ± tooltip olarak gÃ¶ster
                
                // ÅžarkÄ± adÄ±nÄ± gÃ¶ster ve ekleme zamanÄ±nÄ± ekle
                const songName = song.name.replace(/\.[^/.]+$/, ""); // UzantÄ±yÄ± kaldÄ±r
                
                // ÅžarkÄ± adÄ± iÃ§in container
                const songNameContainer = document.createElement('div');
                songNameContainer.className = 'song-name-container';
                
                const songNameElement = document.createElement('span');
                songNameElement.className = 'song-name';
                songNameElement.textContent = songName;
                songNameContainer.appendChild(songNameElement);
                nameSpan.appendChild(songNameContainer);
                
                // Ekleme zamanÄ±nÄ± gÃ¶ster
                if (song.addedAt) {
                    const addedDate = new Date(song.addedAt);
                    const timeString = addedDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const timeElement = document.createElement('span');
                    timeElement.className = 'text-xs text-white/50 ml-2 shrink-0';
                    timeElement.textContent = timeString;
                    nameSpan.appendChild(timeElement);
                }
                
                nameContainer.appendChild(nameSpan);
                
                // Ekleyen kiÅŸi bilgisi
                if (song.addedBy) {
                    const addedBySpan = document.createElement('div');
                    addedBySpan.className = 'text-xs text-white/70 mt-1 flex items-center gap-1 truncate';
                    addedBySpan.innerHTML = `<i class="fas fa-user-plus"></i> <span>Ekleyen: ${song.addedBy}</span>`;
                    nameContainer.appendChild(addedBySpan);
                }
                
                li.appendChild(nameContainer);

                // Butonlar iÃ§in container
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex items-center gap-1 shrink-0';

                // En Ãœste Al butonu
                if (index > 0) { // Ä°lk ÅŸarkÄ± zaten en Ã¼stte olduÄŸu iÃ§in ona buton eklemiyoruz
                    const moveTopButton = document.createElement('button');
                    moveTopButton.className = 'w-7 h-7 flex items-center justify-center rounded-full bg-blue-600 hover:bg-blue-700 text-white';
                    moveTopButton.innerHTML = '<i class="fas fa-arrow-up"></i>';
                    moveTopButton.title = 'En Ãœste Al';
                    moveTopButton.onclick = (e) => {
                        e.stopPropagation();
                        // ÅžarkÄ±yÄ± en Ã¼ste taÅŸÄ±
                        socket.emit('reorderPlaylist', {
                            roomId,
                            oldIndex: index,
                            newIndex: 0
                        });
                    };
                    buttonContainer.appendChild(moveTopButton);
                }

                // Oynat/Duraklat butonu
                const playButton = document.createElement('button');
                playButton.className = `w-7 h-7 flex items-center justify-center rounded-full ${
                    index === currentTrack && isPlaying ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'
                } text-white`;
                playButton.innerHTML = index === currentTrack && isPlaying ? 
                    '<i class="fas fa-pause"></i>' : 
                    '<i class="fas fa-play"></i>';
                playButton.onclick = (e) => {
                    e.stopPropagation();
                    playSong(index);
                };
                buttonContainer.appendChild(playButton);

                li.appendChild(buttonContainer);

                // TÄ±klama olayÄ±nÄ± sadece ÅŸarkÄ± adÄ±na ekleyelim
                nameContainer.onclick = (e) => {
                    e.stopPropagation();
                    playSong(index);
                };
                
                playlist.appendChild(li);
            });
            
            // Debug iÃ§in konsola yazdÄ±r
            console.log(`Ã‡alma listesi gÃ¼ncellendi: ${currentPlaylist.length} ÅŸarkÄ±`);
            
            // Sortable.js ile sÃ¼rÃ¼kle-bÄ±rak Ã¶zelliÄŸini etkinleÅŸtirelim
            if (currentPlaylist.length > 1) {
                initSortable();
            }
        }
        
        // Sortable.js ile sÃ¼rÃ¼kle-bÄ±rak Ã¶zelliÄŸini baÅŸlatan fonksiyon
        function initSortable() {
            if (window.playlistSortable) {
                window.playlistSortable.destroy();
            }
            
            window.playlistSortable = new Sortable(playlist, {
                animation: 150,
                handle: '.sortable-handle',
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onEnd: function(evt) {
                    const oldIndex = evt.oldIndex;
                    const newIndex = evt.newIndex;
                    
                    if (oldIndex !== newIndex) {
                        // Server'a bildir
                        socket.emit('reorderPlaylist', {
                            roomId,
                            oldIndex,
                            newIndex
                        });
                    }
                }
            });
        }
        
        // Ã‡alan ÅŸarkÄ± deÄŸiÅŸtiÄŸinde UI'Ä± gÃ¼ncelle
        socket.on('currentTrackChanged', (index) => {
            currentTrack = index;
            updatePlaylistUI();
        });
        
        // ÅžarkÄ± sÄ±rasÄ± deÄŸiÅŸtirildiÄŸinde bildirim gÃ¶ster
        socket.on('playlistReordered', (data) => {
            if (data.username !== username) {
                showSuccess(`${data.username} "${data.songName}" ÅŸarkÄ±sÄ±nÄ±n sÄ±rasÄ±nÄ± deÄŸiÅŸtirdi`);
            }
        });

        // KullanÄ±cÄ± listesini gÃ¼ncelleyen fonksiyon
        function updateUsersUI(users) {
            const userList = document.getElementById('userList');
            const userCount = document.getElementById('userCount');
            
            userList.innerHTML = '';
            currentUsers.clear();
            
            users.forEach(user => {
                currentUsers.set(user.id, user.name);
                const userElement = document.createElement('div');
                userElement.className = `
                    flex items-center gap-2 px-3 py-2 rounded-lg
                    ${user.id === socket.id ? 'bg-indigo-600' : 'bg-white/10'}
                `;
                
                userElement.innerHTML = `
                    <i class="fas fa-user"></i>
                    <span>${user.name}</span>
                    ${user.id === socket.id ? '<span class="text-xs">(Sen)</span>' : ''}
                `;
                
                userList.appendChild(userElement);
            });
            
            userCount.textContent = `${users.length} KullanÄ±cÄ±`;
        }

        // Event listener'larÄ± ekleyelim
        socket.on('updateUsers', (users) => {
            updateUsersUI(users);
        });

        socket.on('userJoined', (user) => {
            if (user.id !== socket.id) {
                showSuccess(`${user.name} odaya katÄ±ldÄ±`);
            }
        });

        socket.on('userLeft', (user) => {
            showSuccess(`${user.name} odadan ayrÄ±ldÄ±`);
        });

        socket.on('songAdded', (data) => {
            if (data.addedBy !== username) {
                showSuccess(`${data.addedBy} "${data.songName}" ÅŸarkÄ±sÄ±nÄ± ekledi`);
            }
        });

        // Hata ve baÅŸarÄ± mesajlarÄ± iÃ§in yardÄ±mcÄ± fonksiyonlar
        function showError(message) {
            showNotification(message, 'error');
        }

        function showSuccess(message) {
            showNotification(message, 'success');
        }

        function showNotification(message, type) {
            const div = document.createElement('div');
            div.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'error' ? 'bg-red-600' : 
                type === 'info' ? 'bg-blue-600' : 'bg-green-600'
            } text-white`;
            div.textContent = message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        // Link kopyalama fonksiyonu
        function copyLink() {
            const roomLink = `${window.location.origin}?room=${roomId}`;
            navigator.clipboard.writeText(roomLink).then(() => {
                showSuccess('Link kopyalandÄ±!');
            }).catch(err => {
                showError('Link kopyalanamadÄ±');
                console.error('Link kopyalama hatasÄ±:', err);
            });
        }
        
        // Link paylaÅŸma fonksiyonu
        function shareLink() {
            const roomLink = `${window.location.origin}?room=${roomId}`;
            
            if (navigator.share) {
                navigator.share({
                    url: roomLink
                }).then(() => {
                    showSuccess('Link paylaÅŸÄ±ldÄ±!');
                }).catch(err => {
                    console.error('PaylaÅŸÄ±m hatasÄ±:', err);
                    // PaylaÅŸÄ±m baÅŸarÄ±sÄ±z olursa kopyalama yÃ¶ntemini dene
                    copyLink();
                });
            } else {
                // Web Share API desteklenmiyorsa kopyalama yÃ¶ntemini kullan
                copyLink();
            }
        }
        
        // Ã‡alma listesini yenileme fonksiyonu
        function refreshPlaylist() {
            // Yenileme animasyonu gÃ¶ster
            const refreshButton = document.querySelector('.fa-sync-alt');
            refreshButton.classList.add('fa-spin');
            
            // Sunucudan gÃ¼ncel Ã§alma listesini iste
            socket.emit('requestPlaylist', { roomId });
            
            // Bildirim gÃ¶ster
            showSuccess('Ã‡alma listesi yenileniyor...');
            
            // 1 saniye sonra animasyonu durdur
            setTimeout(() => {
                refreshButton.classList.remove('fa-spin');
            }, 1000);
        }

        // Audio player hata yÃ¶netimi
        audioPlayer.addEventListener('error', (e) => {
            let errorMessage = 'Bilinmeyen bir hata oluÅŸtu';
            if (e.target.error) {
                switch (e.target.error.code) {
                    case e.target.error.MEDIA_ERR_ABORTED:
                        errorMessage = 'ÅžarkÄ± yÃ¼klemesi iptal edildi';
                        break;
                    case e.target.error.MEDIA_ERR_NETWORK:
                        errorMessage = 'AÄŸ hatasÄ± oluÅŸtu. ÅžarkÄ± yÃ¼klenemiyor.';
                        break;
                    case e.target.error.MEDIA_ERR_DECODE:
                        errorMessage = 'ÅžarkÄ± Ã§Ã¶zÃ¼mlenemedi. Format desteklenmiyor olabilir.';
                        break;
                    case e.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                        errorMessage = 'Bu ses formatÄ± desteklenmiyor veya dosya bulunamadÄ±.';
                        break;
                }
            }
            console.error('Audio player hatasÄ±:', errorMessage, e);
            showError(errorMessage);
            isAudioLoaded = false;
            
            // ÅžarkÄ±yÄ± yeniden yÃ¼klemeyi dene
            if (currentPlaylist.length > 0 && currentTrack >= 0 && currentTrack < currentPlaylist.length) {
                setTimeout(() => {
                    showNotification('ÅžarkÄ± yeniden yÃ¼kleniyor...', 'info');
                    audioPlayer.src = currentPlaylist[currentTrack].data;
                    audioPlayer.load();
                }, 2000);
            }
        });

        // Oynatma durumu deÄŸiÅŸikliklerini izle
        audioPlayer.addEventListener('play', () => {
            userInitiatedPlay = true; // KullanÄ±cÄ± tarafÄ±ndan baÅŸlatÄ±ldÄ±
            if (!isPlaying) {
                playAudio();
                startSyncInterval();
            }
            updateNowPlayingInfo();
        });

        audioPlayer.addEventListener('pause', () => {
            if (isPlaying) {
                pauseAudio();
                stopSyncInterval();
            }
            updateNowPlayingInfo();
        });
        
        // ÅžarkÄ± ileri/geri sarÄ±ldÄ±ÄŸÄ±nda senkronize et
        audioPlayer.addEventListener('seeked', () => {
            if (isPlaying) {
                // KullanÄ±cÄ± ÅŸarkÄ±yÄ± ileri/geri sardÄ±ÄŸÄ±nda herkese bildir
                playAudio();
                
                // Senkronizasyon zamanÄ±nÄ± sÄ±fÄ±rla
                lastSyncTime = Date.now();
            }
        });
        
        // ÅžarkÄ± yÃ¼klendiÄŸinde
        audioPlayer.addEventListener('loadeddata', () => {
            console.log('ÅžarkÄ± yÃ¼klendi:', currentPlaylist[currentTrack]?.name);
            isAudioLoaded = true;
        });
        
        // ÅžarkÄ± Ã§almaya baÅŸladÄ±ÄŸÄ±nda
        audioPlayer.addEventListener('playing', () => {
            console.log('ÅžarkÄ± Ã§almaya baÅŸladÄ±:', currentPlaylist[currentTrack]?.name);
        });

        // ÅžarkÄ± bittiÄŸinde
        audioPlayer.addEventListener('ended', () => {
            console.log('ÅžarkÄ± bitti:', currentPlaylist[currentTrack]?.name);
            
            // EÄŸer Ã§alma listesinde daha fazla ÅŸarkÄ± varsa bir sonraki ÅŸarkÄ±ya geÃ§
            if (currentPlaylist.length > 0 && currentTrack < currentPlaylist.length - 1) {
                playSong(currentTrack + 1);
            } else {
                // Son ÅŸarkÄ±ysa Ã§almayÄ± durdur
                isPlaying = false;
                stopSyncInterval();
                updatePlaylistUI();
                updateNowPlayingInfo();
            }
        });

        // Sayfa kapatÄ±lÄ±rken veya yenilenirken oturum bilgisini gÃ¼ncelle
        window.addEventListener('beforeunload', function() {
            if (roomId && username) {
                saveSession();
            }
        });

        // Åžu an Ã§alan ÅŸarkÄ± bilgisini gÃ¼ncelle
        function updateNowPlayingInfo() {
            if (currentPlaylist.length > 0 && currentTrack >= 0 && currentTrack < currentPlaylist.length) {
                const currentSong = currentPlaylist[currentTrack];
                
                // ÅžarkÄ± adÄ±nÄ± gÃ¶ster (uzantÄ±yÄ± kaldÄ±r)
                const songName = currentSong.name.replace(/\.[^/.]+$/, "");
                currentSongName.textContent = songName;
                currentSongName.title = songName; // Tooltip olarak tam adÄ± gÃ¶ster
                
                // VarsayÄ±lan kapak resmini gÃ¶ster
                albumCover.src = "https://cdn-icons-png.flaticon.com/512/3844/3844724.png";
                
                // ÅžarkÄ± tÃ¼rÃ¼ne gÃ¶re farklÄ± ikon gÃ¶ster
                const fileExt = currentSong.name.split('.').pop().toLowerCase();
                if (fileExt === 'mp3') {
                    albumCover.src = "https://cdn-icons-png.flaticon.com/512/3844/3844724.png";
                } else if (fileExt === 'flac') {
                    albumCover.src = "https://cdn-icons-png.flaticon.com/512/2306/2306139.png";
                } else if (fileExt === 'wav') {
                    albumCover.src = "https://cdn-icons-png.flaticon.com/512/2306/2306188.png";
                }
                
                // Ã‡alma durumuna gÃ¶re animasyon ekle/kaldÄ±r
                const albumContainer = document.getElementById('albumCoverContainer');
                if (isPlaying && !audioPlayer.paused) {
                    albumContainer.classList.add('animate-pulse-slow');
                } else {
                    albumContainer.classList.remove('animate-pulse-slow');
                }
            } else {
                currentSongName.textContent = "HenÃ¼z bir ÅŸarkÄ± seÃ§ilmedi";
                currentSongName.title = ""; // Tooltip'i temizle
                albumCover.src = "https://cdn-icons-png.flaticon.com/512/3844/3844724.png";
                document.getElementById('albumCoverContainer').classList.remove('animate-pulse-slow');
            }
        }

        // Ses seviyesi kontrolÃ¼
        volumeControl.addEventListener('input', function() {
            audioPlayer.volume = this.value / 100;
            // Ses seviyesi deÄŸiÅŸtiÄŸinde oturum bilgisini gÃ¼ncelle
            saveSession();
        });

        // Sayfa yÃ¼klendiÄŸinde ses seviyesini ayarla
        window.addEventListener('DOMContentLoaded', function() {
            audioPlayer.volume = volumeControl.value / 100;
        });

        // BaÄŸlantÄ± durumunu izle
        socket.on('connect', () => {
            console.log('Sunucuya baÄŸlandÄ±');
            // BaÄŸlantÄ± kurulduÄŸunda oturumu geri yÃ¼kle
            restoreSession();
        });
        
        socket.on('disconnect', () => {
            console.log('Sunucu baÄŸlantÄ±sÄ± kesildi');
            showError('Sunucu baÄŸlantÄ±sÄ± kesildi. Yeniden baÄŸlanÄ±lÄ±yor...');
        });
        
        socket.on('connect_error', (error) => {
            console.error('BaÄŸlantÄ± hatasÄ±:', error);
            showError('Sunucuya baÄŸlanÄ±lamadÄ±. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin.');
        });
    </script>
</body>
</html>
