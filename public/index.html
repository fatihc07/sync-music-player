<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync Music Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aurora.js/0.4.2/aurora.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flac.js/0.3.0/flac.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        /* New Vocatone Header */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 40px;
        }

        .app-logo {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 1px;
            color: #ffffff;
        }

        .app-controls {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .app-controls button {
            background: transparent;
            border: none;
            color: #ffffff;
            font-size: 20px;
            cursor: pointer;
        }

        /* Hero Section */
        .hero-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 60px;
        }

        .hero-content {
            flex: 1;
            max-width: 600px;
        }

        .hero-title {
            font-size: 4rem;
            font-weight: 700;
            margin-bottom: 20px;
            line-height: 1.1;
        }

        .hero-subtitle {
            font-size: 1rem;
            line-height: 1.6;
            color: #cccccc;
            margin-bottom: 30px;
        }

        .play-button-large {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #e91e63 0%, #b71c1c 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(233, 30, 99, 0.3);
            transition: all 0.3s ease;
        }

        .play-button-large:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 25px rgba(233, 30, 99, 0.4);
        }

        .play-button-large i {
            font-size: 30px;
            color: white;
        }

        /* Playlist Section */
        .playlist-section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 30px;
        }

        .playlist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 60px;
        }

        .playlist-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .playlist-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .playlist-card-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
        }

        .playlist-card-title {
            padding: 15px;
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
        }

        /* Now Playing Card */
        .now-playing-card {
            background: rgba(40, 40, 40, 0.6);
            border-radius: 20px;
            overflow: hidden;
            padding: 20px;
            display: flex;
            flex-direction: column;
            max-width: 400px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
            margin-bottom: 40px;
        }

        .now-playing-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .now-playing-info {
            margin-bottom: 20px;
        }

        .now-playing-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .now-playing-artist {
            font-size: 1rem;
            color: #cccccc;
        }

        .player-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .control-button {
            background: transparent;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .control-button:hover {
            color: #e91e63;
        }

        .play-pause-button {
            background: white;
            color: #1a1a1a;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .play-pause-button:hover {
            transform: scale(1.1);
        }

        .progress-container {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #e91e63 0%, #b71c1c 100%);
            border-radius: 2px;
            width: 30%;
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #cccccc;
        }

        /* Main Container Layout */
        .main-container {
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
        }

        .content-area {
            display: flex;
            gap: 40px;
        }

        .left-panel {
            flex: 1;
        }

        .right-panel {
            width: 400px;
        }

        /* Room Info Styling */
        .room-info {
            background: rgba(40, 40, 40, 0.6);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .room-info-content {
            margin-top: 15px;
        }

        .room-info h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .users {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .user-tag {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .user-tag:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Playlist Styling */
        .playlist {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .playlist-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .playlist-item.active {
            background: rgba(233, 30, 99, 0.2);
            border-left: 4px solid #e91e63;
        }

        .song-number {
            width: 30px;
            font-size: 0.9rem;
            color: #cccccc;
        }

        .song-info {
            flex: 1;
        }

        .song-title {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .song-artist {
            font-size: 0.8rem;
            color: #cccccc;
        }

        .song-duration {
            font-size: 0.9rem;
            color: #cccccc;
        }

        /* Login Container */
        .login-container {
            background: rgba(40, 40, 40, 0.6);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            margin: 100px auto;
        }

        .login-content {
            margin-top: 20px;
        }

        .login-container input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        .login-container input::placeholder {
            color: #aaaaaa;
        }

        .login-container button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #e91e63 0%, #b71c1c 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .login-container button:hover {
            box-shadow: 0 5px 15px rgba(233, 30, 99, 0.4);
        }

        /* Upload Button */
        .upload-button {
            background: linear-gradient(135deg, #e91e63 0%, #b71c1c 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-button:hover {
            box-shadow: 0 5px 15px rgba(233, 30, 99, 0.4);
        }

        .upload-progress-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .upload-progress-text {
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .upload-progress-bar-container {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .upload-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #e91e63 0%, #b71c1c 100%);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Delete Room Button */
        .delete-room-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #ff4d4d;
            border: 1px solid #ff4d4d;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 20px;
        }

        .delete-room-btn:hover {
            background: rgba(255, 77, 77, 0.1);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .content-area {
                flex-direction: column;
            }

            .right-panel {
                width: 100%;
            }

            .hero-title {
                font-size: 3rem;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .app-header {
                margin-bottom: 30px;
            }

            .hero-section {
                flex-direction: column;
                text-align: center;
                margin-bottom: 40px;
            }

            .hero-content {
                margin-bottom: 30px;
            }

            .hero-title {
                font-size: 2.5rem;
            }

            .playlist-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .now-playing-card {
                margin: 0 auto 30px;
            }

            .play-button-large {
                margin: 0 auto;
            }
        }

        @media (max-width: 480px) {
            .hero-title {
                font-size: 2rem;
            }

            .playlist-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .app-controls {
                gap: 15px;
            }
        }

        /* Hide elements initially */
        #player-container, #playlist-section, #room-info, #upload-container {
            display: none;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-gray-800">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <h1 class="text-4xl font-bold text-center mb-8">🎵 Sync Music Player</h1>

        <!-- Oda Linki Bölümü - Her zaman üstte görünecek -->
        <div id="roomLinkSection" style="display: none;" class="glass-effect rounded-xl p-4 mb-6 sticky top-2 z-10">
            <div class="flex flex-col md:flex-row items-center justify-between gap-3">
                <div class="flex-1">
                    <div class="flex items-center gap-2">
                        <span class="font-bold whitespace-nowrap">Oda Linki:</span>
                        <span id="roomLinkText" class="bg-white/10 px-3 py-1 rounded text-indigo-300 truncate"></span>
                    </div>
                </div>
                <div class="flex gap-2 shrink-0">
                    <button onclick="copyLink()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center gap-2">
                        <i class="fas fa-copy"></i>
                        <span class="hidden md:inline">Linki Kopyala</span>
                    </button>
                    <button onclick="shareLink()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center gap-2">
                        <i class="fas fa-share-alt"></i>
                        <span class="hidden md:inline">Paylaş</span>
                    </button>
                    <button onclick="confirmDeleteRoom()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 flex items-center gap-2">
                        <i class="fas fa-trash-alt"></i>
                        <span class="hidden md:inline">Odayı Sil</span>
                    </button>
                </div>
            </div>
    </div>

        <!-- Oda Oluşturma Bölümü -->
        <div id="createJoinSection" class="glass-effect rounded-xl p-6 mb-6">
            <button onclick="createRoom()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center gap-2">
                <i class="fas fa-plus-circle"></i>
                Yeni Oda Oluştur
            </button>
    </div>

        <!-- Giriş Bölümü -->
        <div id="loginSection" style="display: none;" class="glass-effect rounded-xl p-6 mb-6">
            <div class="flex gap-3">
                <input type="text" id="username" placeholder="Kullanıcı adınız" 
                    class="flex-1 px-4 py-2 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:border-indigo-500">
                <button onclick="login()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                    <i class="fas fa-sign-in-alt mr-2"></i>Giriş Yap
                </button>
            </div>
        </div>
        
        <!-- Kullanıcılar Bölümü -->
        <div id="userSection" class="glass-effect rounded-xl p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i class="fas fa-users"></i>
                    Odadaki Kullanıcılar
                </h3>
                <span id="userCount" class="bg-indigo-600 px-3 py-1 rounded-full text-sm">0 Kullanıcı</span>
            </div>
            <div class="flex flex-wrap gap-2" id="userList"></div>
            <div class="mt-4 text-sm text-white/70 bg-white/10 p-3 rounded-lg">
                <p class="flex items-center gap-2"><i class="fas fa-info-circle"></i> Odadaki herkes şarkı ekleyebilir ve çalma listesini kontrol edebilir.</p>
            </div>
        </div>
        
        <!-- Müzik Çalar Bölümü -->
        <div id="playerSection" style="display: none;" class="space-y-6">
            <!-- İki sütunlu düzen oluşturalım -->
            <div class="flex flex-col md:flex-row gap-6">
                <!-- Sol sütun: Çalma Listesi -->
                <div class="md:w-1/2 playlist-container">
                    <div class="glass-effect rounded-xl p-6 h-full flex flex-col">
                        <div class="heading-card">
                            <div class="heading-content">
                                <span class="heading-icon"><i class="fas fa-music"></i></span>
                                <h2>Çalma Listesi</h2>
                            </div>
                        </div>
                        <div id="playlist" class="playlist"></div>
                        <p class="text-sm text-gray-500 mb-3">
                            <i class="fas fa-arrows-alt mr-1"></i> Şarkıları sürükleyip bırakarak sıralamayı değiştirebilirsiniz
                        </p>
                        <div class="playlist-scroll">
                            <ul id="playlist" class="space-y-2"></ul>
                        </div>
                    </div>
                </div>
                
                <!-- Sağ sütun: Kontroller -->
                <div class="md:w-1/2">
                    <div class="glass-effect rounded-xl p-6 flex flex-col items-center">
                        <!-- Albüm kapağı (varsayılan) -->
                        <div id="albumCoverContainer" class="mb-6 relative">
                            <img id="albumCover" src="https://placehold.co/400x400/4f46e5/ffffff?text=🎵" alt="Album Cover" class="album-cover">
                            <!-- Ses dalgası animasyonu -->
                            <div class="sound-wave mt-4" id="soundWave"></div>
                        </div>
                        
                        <!-- Şarkı bilgisi -->
                        <div class="song-info w-full">
                            <div class="flex items-center justify-center gap-2 mb-1">
                                <span class="now-playing-badge" id="nowPlayingBadge">Şimdi Çalıyor</span>
                            </div>
                            <h3 id="songTitle" class="song-title truncate">Şarkı Seçilmedi</h3>
                            <p id="songArtist" class="song-artist truncate">Lütfen bir şarkı seçin</p>
                        </div>
                        
                        <!-- İlerleme çubuğu -->
                        <div class="w-full mt-6">
                            <div class="flex justify-between text-sm text-gray-500">
                                <span id="currentTime">0:00</span>
                                <span id="totalTime">0:00</span>
                            </div>
                            <div class="progress-container" id="progressContainer">
                                <div class="progress-bar" id="progressBar"></div>
                                <div class="progress-handle" id="progressHandle"></div>
                            </div>
                        </div>
                        
                        <!-- Kontrol butonları -->
                        <div class="flex items-center justify-center gap-4 mt-4">
                            <button class="control-button" onclick="playPrevious()">
                                <i class="fas fa-step-backward text-gray-700"></i>
                            </button>
                            <button id="playPauseButton" class="control-button play-button" onclick="togglePlayPause()">
                                <i class="fas fa-play text-xl"></i>
                            </button>
                            <button class="control-button" onclick="playNext()">
                                <i class="fas fa-step-forward text-gray-700"></i>
                            </button>
                        </div>
                        
                        <!-- Şarkı ekleme butonu -->
                        <div class="w-full mt-8">
                            <label class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition duration-300 flex items-center justify-center gap-2 w-full">
                                <i class="fas fa-music mr-2"></i>
                                Şarkı Ekle
                                <input type="file" id="localFile" accept=".mp3,.flac,.wav,audio/mp3,audio/flac,audio/wav" onchange="addLocalFile()" multiple class="hidden">
                            </label>
                            <p class="text-xs text-gray-500 mt-2 text-center">Desteklenen formatlar: MP3, FLAC, WAV</p>
                            
                            <!-- Yükleme ilerleme çubuğu -->
                            <div id="uploadProgressContainer" class="mt-4 hidden">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-sm text-gray-600" id="uploadProgressText">Yükleniyor: 0%</span>
                                    <span class="text-sm text-gray-600" id="uploadProgressFile"></span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div id="uploadProgressBar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Gizli audio player -->
                        <audio id="audioPlayer" class="hidden"></audio>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation (only visible on small screens) -->
    <div class="mobile-nav" id="mobile-nav" style="display: none;">
        <div class="mobile-nav-button active" onclick="showPlayerTab()">
            <i class="fas fa-music"></i>
            <span>Çalan</span>
        </div>
        <div class="mobile-nav-button" onclick="showPlaylistTab()">
            <i class="fas fa-list"></i>
            <span>Liste</span>
        </div>
        <div class="mobile-nav-button" onclick="showUsersTab()">
            <i class="fas fa-users"></i>
            <span>Kullanıcılar</span>
        </div>
        <div class="mobile-nav-button" onclick="showSettingsTab()">
            <i class="fas fa-cog"></i>
            <span>Ayarlar</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
    <script>
        // Socket.IO bağlantısı
        const socket = io(window.location.origin, {
            reconnectionAttempts: 5,
            timeout: 10000
        });
        
        // Global değişkenler
        let username = '';
        let currentTrack = 0;
        let roomId = '';
        let currentPlaylist = [];
        let isPlaying = false;
        let currentUsers = new Map();
        let serverTimeOffset = 0; // Ekle: Sunucu ve istemci arasındaki zaman farkı
        let syncInterval; // Ekle: Senkronizasyon için interval
        
        const audioPlayer = document.getElementById('audioPlayer');
        const playlist = document.getElementById('playlist');

        // URL'den room ID'yi al
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('room')) {
            roomId = urlParams.get('room');
            const roomLink = `${window.location.origin}?room=${roomId}`;
            
            // Oda linkini üstteki bölümde göster
            document.getElementById('roomLinkText').textContent = roomLink;
            document.getElementById('roomLinkSection').style.display = 'block';
            document.getElementById('createJoinSection').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
            
            // Oturum bilgisini kontrol et
            checkSavedSession();
        }
        
        // Oda silme onay fonksiyonu
        function confirmDeleteRoom() {
            if (confirm('Bu odayı silmek istediğinize emin misiniz? Bu işlem geri alınamaz ve tüm şarkılar silinecektir.')) {
                deleteRoom();
            }
        }
        
        // Oda silme fonksiyonu
        function deleteRoom() {
            if (roomId) {
                socket.emit('deleteRoom', { roomId });
                showSuccess('Oda siliniyor...');
            }
        }
        
        // Oda silindiğinde
        socket.on('roomDeleted', (data) => {
            showError(data.message);
            
            // Oturum bilgisini temizle
            localStorage.removeItem('musicRoomSession');
            
            // Tüm bölümleri sıfırla
            document.getElementById('playerSection').style.display = 'none';
            document.getElementById('userSection').style.display = 'none';
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('roomLinkSection').style.display = 'none';
            document.getElementById('createJoinSection').style.display = 'block';
            
            // Çalma listesini temizle
            currentPlaylist = [];
            updatePlaylistUI();
            
            // Audio player'ı durdur ve sıfırla
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.src = '';
            }
            
            // Senkronizasyon interval'ini durdur
            stopSyncInterval();
            
            // URL'yi temizle
            window.history.pushState({}, '', window.location.pathname);
            
            // Kullanıcı bilgilerini sıfırla
            username = '';
            roomId = '';
            currentTrack = 0;
            isPlaying = false;
            
            // 3 saniye sonra ana sayfaya yönlendirme yerine hemen ana ekranı göster
            // setTimeout(() => {
            //     window.location.href = window.location.origin;
            // }, 3000);
        });
        
        // Oturum bilgisini localStorage'a kaydet
        function saveSession() {
            if (roomId && username) {
                const sessionData = {
                    roomId,
                    username,
                    timestamp: Date.now()
                };
                localStorage.setItem('musicRoomSession', JSON.stringify(sessionData));
                console.log('Oturum bilgisi kaydedildi:', sessionData);
            }
        }
        
        // Kaydedilmiş oturum bilgisini kontrol et
        function checkSavedSession() {
            const savedSession = localStorage.getItem('musicRoomSession');
            if (savedSession) {
                try {
                    const sessionData = JSON.parse(savedSession);
                    
                    // Oturum 24 saatten eski mi kontrol et
                    const sessionAge = Date.now() - sessionData.timestamp;
                    const oneDayInMs = 24 * 60 * 60 * 1000;
                    
                    if (sessionAge < oneDayInMs && sessionData.roomId === roomId) {
                        // Kullanıcı adını giriş alanına yerleştir
                        document.getElementById('username').value = sessionData.username;
                    }
                } catch (error) {
                    console.error('Oturum bilgisi okunamadı:', error);
                    localStorage.removeItem('musicRoomSession');
                }
            }
        }
        
        // Sayfa yenilendiğinde oturumu geri yükle
        function restoreSession() {
            const savedSession = localStorage.getItem('musicRoomSession');
            if (savedSession && socket.connected) {
                try {
                    const sessionData = JSON.parse(savedSession);
                    
                    // Oturum 24 saatten eski mi kontrol et
                    const sessionAge = Date.now() - sessionData.timestamp;
                    const oneDayInMs = 24 * 60 * 60 * 1000;
                    
                    if (sessionAge < oneDayInMs) {
                        // URL'deki oda ID'si ile kaydedilen oda ID'si aynı mı kontrol et
                        if (roomId && roomId === sessionData.roomId) {
                            username = sessionData.username;
                            
                            // Otomatik giriş yap
                            document.getElementById('loginSection').style.display = 'none';
                            document.getElementById('createJoinSection').style.display = 'none';
                            document.getElementById('playerSection').style.display = 'block';
                            document.getElementById('userSection').style.display = 'block';
                            
                            // Odaya katıl
                            socket.emit('joinRoom', { roomId, username });
                            
                            showSuccess('Oturumunuz geri yüklendi');
                            console.log('Oturum geri yüklendi:', sessionData);
                        }
                    } else {
                        // Oturum süresi dolmuş, localStorage'dan kaldır
                        localStorage.removeItem('musicRoomSession');
                    }
                } catch (error) {
                    console.error('Oturum geri yüklenirken hata:', error);
                    localStorage.removeItem('musicRoomSession');
                }
            }
        }

        function createRoom() {
            socket.emit('createRoom');
            showPlayerInterface();
        }

        socket.on('roomCreated', (newRoomId) => {
            roomId = newRoomId;
            const roomLink = `${window.location.origin}?room=${roomId}`;
            
            // Oda linkini üstteki bölümde göster
            document.getElementById('roomLinkText').textContent = roomLink;
            document.getElementById('roomLinkSection').style.display = 'block';
            document.getElementById('loginSection').style.display = 'block';
            
            // URL'yi güncelle (sayfa yenilenmeden)
            window.history.pushState({}, '', `?room=${roomId}`);
            
            // Oda oluşturulduğunda createJoinSection'ı gizle
            document.getElementById('createJoinSection').style.display = 'none';
        });

        function login() {
            username = document.getElementById('username').value;
            if (username.trim() !== '') {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('createJoinSection').style.display = 'none';
                document.getElementById('playerSection').style.display = 'block';
                document.getElementById('userSection').style.display = 'block'; // Kullanıcılar bölümünü göster
                socket.emit('joinRoom', { roomId, username });
                
                // Oturum bilgisini kaydet
                saveSession();
            }
        }

        function addLocalFile() {
            const files = document.getElementById('localFile').files;
            let filesAdded = 0;
            const totalFiles = files.length;
            
            if (totalFiles === 0) {
                return;
            }
            
            // İlerleme çubuğunu göster ve sıfırla
            const progressContainer = document.getElementById('uploadProgressContainer');
            const progressBar = document.getElementById('uploadProgressBar');
            const progressText = document.getElementById('uploadProgressText');
            const progressFile = document.getElementById('uploadProgressFile');
            
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressText.textContent = 'Yükleniyor: 0%';
            progressFile.textContent = '';
            
            showSuccess(`${totalFiles} şarkı yükleniyor...`);
            console.log(`Yükleme başlatıldı: ${totalFiles} dosya`);
            
            // Her dosya için toplam ilerlemeyi hesaplamak için
            let totalProgress = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                if (file.size > 50 * 1024 * 1024) {
                    showError(`${file.name} dosyası çok büyük (Max: 50MB)`);
                    continue;
                }

                console.log(`Dosya işleniyor: ${file.name}, boyut: ${(file.size / 1024 / 1024).toFixed(2)}MB`);
                progressFile.textContent = `${file.name} (${i+1}/${totalFiles})`;
                
                const reader = new FileReader();
                
                // İlerleme olayını dinle
                reader.onprogress = function(e) {
                    if (e.lengthComputable) {
                        // Mevcut dosya için ilerleme yüzdesi
                        const fileProgress = Math.round((e.loaded / e.total) * 100);
                        
                        // Tüm dosyalar için toplam ilerleme yüzdesi
                        // Her dosya eşit ağırlıkta kabul edilir
                        const fileContribution = fileProgress / totalFiles;
                        const previousFilesContribution = (i / totalFiles) * 100;
                        totalProgress = previousFilesContribution + fileContribution;
                        
                        // İlerleme çubuğunu güncelle
                        progressBar.style.width = `${totalProgress}%`;
                        progressText.textContent = `Yükleniyor: ${Math.round(totalProgress)}%`;
                    }
                };
                
                reader.onload = function(e) {
                    console.log(`Dosya okundu: ${file.name}`);
                    
                    try {
                    const song = {
                        name: file.name,
                            data: e.target.result,
                            addedBy: username
                        };
                        
                        console.log(`Sunucuya gönderiliyor: ${file.name}`);
                        progressText.textContent = `${file.name} sunucuya yükleniyor...`;
                        
                        socket.emit('addSong', { roomId, song }, (response) => {
                            if (response && response.success) {
                                console.log(`Şarkı başarıyla eklendi: ${file.name}`);
                                filesAdded++;
                                
                                // Tüm dosyalar tamamlandıysa
                                if (filesAdded === totalFiles) {
                                    showSuccess(`${totalFiles} şarkı başarıyla eklendi`);
                                    // İlerleme çubuğunu gizle
                                    setTimeout(() => {
                                        progressContainer.classList.add('hidden');
                                    }, 2000);
                                    // Dosya seçiciyi sıfırla
                                    document.getElementById('localFile').value = '';
                                }
                            } else if (response && response.error) {
                                showError(`Hata: ${response.error}`);
                                console.error(`Şarkı eklenirken hata: ${response.error}`);
                            }
                        });
                    } catch (error) {
                        console.error(`Şarkı işlenirken hata: ${error.message}`);
                        showError(`Şarkı işlenirken hata: ${error.message}`);
                    }
                };
                
                reader.onerror = function(error) {
                    console.error(`Dosya okuma hatası: ${error}`);
                    showError(`${file.name} yüklenirken hata oluştu`);
                };
                
                // Dosyayı base64 olarak oku
                reader.readAsDataURL(file);
            }
        }

        function playMusic() {
            socket.emit('play', { roomId, currentTime: audioPlayer.currentTime });
        }

        function pauseMusic() {
            socket.emit('pause', { roomId, currentTime: audioPlayer.currentTime });
        }

        function playSong(index) {
            if (index >= 0 && index < currentPlaylist.length) {
            currentTrack = index;
            socket.emit('playSong', { roomId, index });
            }
        }
        
        // Ekle: Senkronizasyon isteği gönderen fonksiyon
        function requestSync() {
            if (roomId && isPlaying) {
                socket.emit('requestSync', { roomId });
            }
        }
        
        // Ekle: Periyodik senkronizasyon başlat
        function startSyncInterval() {
            // Önceki interval'i temizle
            if (syncInterval) {
                clearInterval(syncInterval);
            }
            
            // Her 10 saniyede bir senkronizasyon iste
            syncInterval = setInterval(requestSync, 10000);
        }
        
        // Ekle: Periyodik senkronizasyon durdur
        function stopSyncInterval() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
            }
        }

        socket.on('updatePlaylist', (songs) => {
            currentPlaylist = songs;
            updatePlaylistUI();
            
            // Şarkı sayısını güncelle
            document.getElementById('songCount').textContent = songs.length;
            
            // Senkronizasyon iste
            requestSync();
        });

        socket.on('play', (currentTime) => {
            // Çalma durumunu güncelle
            isPlaying = true;
            
            // Şarkı pozisyonunu ayarla
            audioPlayer.currentTime = currentTime;
            
            // Şarkıyı çal
            const playPromise = audioPlayer.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    showError('Şarkı çalınırken hata: ' + error.message);
                });
            }
            
            // Senkronizasyon interval'ini başlat
            startSyncInterval();
            
            // UI'ı güncelle
            updatePlaylistUI();
            updatePlayPauseButton();
            document.getElementById('nowPlayingBadge').style.display = 'inline-block';
            document.getElementById('albumCoverContainer').classList.add('playing');
        });

        socket.on('pause', (currentTime) => {
            // Çalma durumunu güncelle
            isPlaying = false;
            
            // Şarkı pozisyonunu ayarla
            audioPlayer.currentTime = currentTime;
            
            // Şarkıyı duraklat
            audioPlayer.pause();
            
            // Senkronizasyon interval'ini durdur
            stopSyncInterval();
            
            // UI'ı güncelle
            updatePlaylistUI();
            updatePlayPauseButton();
            document.getElementById('nowPlayingBadge').style.display = 'none';
            document.getElementById('albumCoverContainer').classList.remove('playing');
        });

        socket.on('playSong', (data) => {
            // Çalma durumunu ve mevcut şarkıyı güncelle
            currentTrack = data.index;
            isPlaying = true;
            
            // Sunucu zaman farkını hesapla
            if (data.serverTime) {
                serverTimeOffset = Date.now() - data.serverTime;
            }
            
            // Audio player'ı ayarla
            audioPlayer.src = data.song.data;
            
            // Otomatik çalma parametresine göre çal veya çalma
            if (data.autoplay) {
                const playPromise = audioPlayer.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        showError('Şarkı çalınırken hata: ' + error.message);
                    });
                }
                
                // Senkronizasyon interval'ini başlat
                startSyncInterval();
                
                // UI güncellemeleri
                document.getElementById('nowPlayingBadge').style.display = 'inline-block';
                document.getElementById('albumCoverContainer').classList.add('playing');
            } else {
                audioPlayer.pause();
                stopSyncInterval();
                
                // UI güncellemeleri
                document.getElementById('nowPlayingBadge').style.display = 'none';
                document.getElementById('albumCoverContainer').classList.remove('playing');
            }
            
            // UI'ı güncelle
            updatePlaylistUI();
            updatePlayPauseButton();
        });
        
        // Ekle: Senkronizasyon bilgisi alındığında
        socket.on('syncPlayback', (data) => {
            if (isPlaying && !audioPlayer.paused) {
                // Sunucu zaman farkını güncelle
                if (data.serverTime) {
                    serverTimeOffset = Date.now() - data.serverTime;
                }
                
                // Mevcut pozisyon ile sunucudan gelen pozisyon arasındaki farkı hesapla
                const currentDiff = Math.abs(audioPlayer.currentTime - data.currentTime);
                
                // Eğer fark 1 saniyeden fazlaysa senkronize et
                if (currentDiff > 1) {
                    console.log(`Şarkı senkronize ediliyor: ${audioPlayer.currentTime.toFixed(2)}s -> ${data.currentTime.toFixed(2)}s`);
                    audioPlayer.currentTime = data.currentTime;
                }
            }
        });

        socket.on('syncState', (state) => {
            isPlaying = state.isPlaying;
            currentTrack = state.currentTrack;
            
            if (state.isPlaying) {
                audioPlayer.currentTime = state.currentTime;
                const playPromise = audioPlayer.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        showError('Şarkı çalınırken hata: ' + error.message);
                    });
                }
                
                // Senkronizasyon interval'ini başlat
                startSyncInterval();
            } else {
                audioPlayer.currentTime = state.currentTime;
                audioPlayer.pause();
                
                // Senkronizasyon interval'ini durdur
                stopSyncInterval();
            }
            
            updatePlaylistUI();
        });

        // Çalma listesi UI'ını güncelleyen fonksiyon
        function updatePlaylistUI() {
            playlist.innerHTML = '';
            
            // Çalma listesi boşsa bir mesaj göster
            if (currentPlaylist.length === 0) {
                const emptyMessage = document.createElement('li');
                emptyMessage.className = 'p-4 text-center text-gray-400';
                emptyMessage.innerHTML = '<i class="fas fa-music mr-2"></i> Henüz şarkı eklenmemiş';
                playlist.appendChild(emptyMessage);
                document.getElementById('songCount').textContent = '0';
                
                // Şarkı bilgilerini sıfırla
                document.getElementById('songTitle').textContent = 'Şarkı Seçilmedi';
                document.getElementById('songArtist').textContent = 'Lütfen bir şarkı seçin';
                document.getElementById('nowPlayingBadge').style.display = 'none';
                return;
            }
            
            // Şarkı sayısını güncelle
            document.getElementById('songCount').textContent = currentPlaylist.length;
            
            // Her şarkı için bir liste öğesi oluştur
            currentPlaylist.forEach((song, index) => {
                const li = document.createElement('li');
                const isActive = index === currentTrack;
                
                li.className = `playlist-item-modern ${isActive ? 'playlist-item-active bg-indigo-50' : 'bg-white/80'}`;
                li.dataset.index = index;
                
                // Şarkı numarası
                const numberSpan = document.createElement('div');
                numberSpan.className = 'playlist-item-number';
                numberSpan.textContent = index + 1;
                li.appendChild(numberSpan);
                
                // Sürükle-bırak için tutamaç
                const dragHandle = document.createElement('span');
                dragHandle.className = 'sortable-handle text-gray-400';
                dragHandle.innerHTML = '<i class="fas fa-grip-lines"></i>';
                li.appendChild(dragHandle);

                // Şarkı bilgileri
                const infoDiv = document.createElement('div');
                infoDiv.className = 'playlist-item-info';
                
                // Şarkı adı
                const titleDiv = document.createElement('div');
                titleDiv.className = 'playlist-item-title';
                const songName = song.name.replace(/\.[^/.]+$/, ""); // Uzantıyı kaldır
                titleDiv.textContent = songName;
                infoDiv.appendChild(titleDiv);
                
                // Ekleyen kişi
                const artistDiv = document.createElement('div');
                artistDiv.className = 'playlist-item-artist';
                artistDiv.textContent = `Ekleyen: ${song.addedBy || 'Bilinmeyen'}`;
                infoDiv.appendChild(artistDiv);
                
                li.appendChild(infoDiv);
                
                // Şarkı süresi veya ekleme zamanı
                if (song.addedAt) {
                    const timeDiv = document.createElement('div');
                    timeDiv.className = 'playlist-item-duration';
                    const addedDate = new Date(song.addedAt);
                    const timeString = addedDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    timeDiv.textContent = timeString;
                    li.appendChild(timeDiv);
                }
                
                // Oynat butonu
                const playButton = document.createElement('button');
                playButton.className = 'w-8 h-8 flex items-center justify-center rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200';
                playButton.innerHTML = isActive && isPlaying ? 
                    '<i class="fas fa-pause"></i>' : 
                    '<i class="fas fa-play"></i>';
                playButton.onclick = (e) => {
                    e.stopPropagation();
                    playSong(index);
                };
                li.appendChild(playButton);
                
                // Tıklama olayı
                li.onclick = () => playSong(index);
                
                playlist.appendChild(li);
            });
            
            // Sortable.js ile sürükle-bırak özelliğini etkinleştirelim
            if (currentPlaylist.length > 1) {
                initSortable();
            }
            
            // Şu an çalan şarkının bilgilerini güncelle
            updateNowPlayingInfo();
        }
        
        // Şu an çalan şarkı bilgilerini güncelle
        function updateNowPlayingInfo() {
            if (currentPlaylist.length > 0 && currentTrack >= 0 && currentTrack < currentPlaylist.length) {
                const currentSong = currentPlaylist[currentTrack];
                const songName = currentSong.name.replace(/\.[^/.]+$/, ""); // Uzantıyı kaldır
                
                document.getElementById('songTitle').textContent = songName;
                document.getElementById('songArtist').textContent = `Ekleyen: ${currentSong.addedBy || 'Bilinmeyen'}`;
                document.getElementById('nowPlayingBadge').style.display = isPlaying ? 'inline-block' : 'none';
                
                // Albüm kapağı animasyonunu güncelle
                const albumCoverContainer = document.getElementById('albumCoverContainer');
                if (isPlaying) {
                    albumCoverContainer.classList.add('playing');
                } else {
                    albumCoverContainer.classList.remove('playing');
                }
            }
        }
        
        // Oynat/Duraklat düğmesini güncelle
        function updatePlayPauseButton() {
            const playPauseButton = document.getElementById('playPauseButton');
            if (isPlaying) {
                playPauseButton.innerHTML = '<i class="fas fa-pause text-xl"></i>';
            } else {
                playPauseButton.innerHTML = '<i class="fas fa-play text-xl"></i>';
            }
        }
        
        // Oynat/Duraklat düğmesine tıklandığında
        function togglePlayPause() {
            if (currentPlaylist.length === 0) {
                showError('Lütfen önce bir şarkı ekleyin');
                return;
            }
            
            if (isPlaying) {
                pauseMusic();
            } else {
                playMusic();
            }
        }
        
        // Önceki şarkıyı çal
        function playPrevious() {
            if (currentPlaylist.length === 0) return;
            
            let prevTrack = currentTrack - 1;
            if (prevTrack < 0) {
                prevTrack = currentPlaylist.length - 1; // Listenin sonuna git
            }
            
            playSong(prevTrack);
        }
        
        // Sonraki şarkıyı çal
        function playNext() {
            if (currentPlaylist.length === 0) return;
            
            let nextTrack = currentTrack + 1;
            if (nextTrack >= currentPlaylist.length) {
                nextTrack = 0; // Listenin başına dön
            }
            
            playSong(nextTrack);
        }
        
        // İlerleme çubuğunu güncelle
        function updateProgressBar() {
            if (!audioPlayer.duration) return;
            
            const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            document.getElementById('progressBar').style.width = `${progressPercent}%`;
            document.getElementById('progressHandle').style.left = `${progressPercent}%`;
            
            // Zaman bilgisini güncelle
            document.getElementById('currentTime').textContent = formatTime(audioPlayer.currentTime);
            document.getElementById('totalTime').textContent = formatTime(audioPlayer.duration);
        }
        
        // Saniyeyi MM:SS formatına dönüştür
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }
        
        // İlerleme çubuğuna tıklandığında
        function setupProgressBar() {
            const progressContainer = document.getElementById('progressContainer');
            
            progressContainer.addEventListener('click', function(e) {
                if (!audioPlayer.duration) return;
                
                const rect = this.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const width = rect.width;
                const percentage = x / width;
                
                audioPlayer.currentTime = percentage * audioPlayer.duration;
                
                // Yeni pozisyonu sunucuya bildir
                if (isPlaying) {
                    socket.emit('play', { roomId, currentTime: audioPlayer.currentTime });
                }
            });
        }

        // Çalan şarkı değiştiğinde UI'ı güncelle
        socket.on('currentTrackChanged', (index) => {
            currentTrack = index;
            updatePlaylistUI();
        });
        
        // Şarkı sırası değiştirildiğinde bildirim göster
        socket.on('playlistReordered', (data) => {
            if (data.username !== username) {
                showSuccess(`${data.username} "${data.songName}" şarkısının sırasını değiştirdi`);
            }
        });

        // Kullanıcı listesini güncelleyen fonksiyon
        function updateUsersUI(users) {
            const userList = document.getElementById('userList');
            const userCount = document.getElementById('userCount');
            
            userList.innerHTML = '';
            currentUsers.clear();
            
            users.forEach(user => {
                currentUsers.set(user.id, user.name);
                const userElement = document.createElement('div');
                userElement.className = `
                    flex items-center gap-2 px-3 py-2 rounded-lg
                    ${user.id === socket.id ? 'bg-indigo-600' : 'bg-white/10'}
                `;
                
                userElement.innerHTML = `
                    <i class="fas fa-user"></i>
                    <span>${user.name}</span>
                    ${user.id === socket.id ? '<span class="text-xs">(Sen)</span>' : ''}
                `;
                
                userList.appendChild(userElement);
            });
            
            userCount.textContent = `${users.length} Kullanıcı`;
        }

        // Event listener'ları ekleyelim
        socket.on('updateUsers', (users) => {
            updateUsersUI(users);
        });

        socket.on('userJoined', (user) => {
            if (user.id !== socket.id) {
                showSuccess(`${user.name} odaya katıldı`);
            }
        });

        socket.on('userLeft', (user) => {
            showSuccess(`${user.name} odadan ayrıldı`);
        });

        socket.on('songAdded', (data) => {
            if (data.addedBy !== username) {
                showSuccess(`${data.addedBy} "${data.songName}" şarkısını ekledi`);
            }
        });

        // Hata ve başarı mesajları için yardımcı fonksiyonlar
        function showError(message) {
            showNotification(message, 'error');
        }

        function showSuccess(message) {
            showNotification(message, 'success');
        }

        function showNotification(message, type) {
            const div = document.createElement('div');
            div.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'error' ? 'bg-red-600' : 'bg-green-600'
            } text-white`;
            div.textContent = message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        // Link kopyalama fonksiyonu
        function copyLink() {
            const roomLink = `${window.location.origin}?room=${roomId}`;
            navigator.clipboard.writeText(roomLink).then(() => {
                showSuccess('Link kopyalandı!');
            }).catch(err => {
                showError('Link kopyalanamadı');
                console.error('Link kopyalama hatası:', err);
            });
        }
        
        // Link paylaşma fonksiyonu
        function shareLink() {
            const roomLink = `${window.location.origin}?room=${roomId}`;
            
            if (navigator.share) {
                navigator.share({
                    url: roomLink
                }).then(() => {
                    showSuccess('Link paylaşıldı!');
                }).catch(err => {
                    console.error('Paylaşım hatası:', err);
                    // Paylaşım başarısız olursa kopyalama yöntemini dene
                    copyLink();
                });
            } else {
                // Web Share API desteklenmiyorsa kopyalama yöntemini kullan
                copyLink();
            }
        }
        
        // Çalma listesini yenileme fonksiyonu
        function refreshPlaylist() {
            // Yenileme animasyonu göster
            const refreshButton = document.querySelector('.fa-sync-alt');
            refreshButton.classList.add('fa-spin');
            
            // Sunucudan güncel çalma listesini iste
            socket.emit('requestPlaylist', { roomId });
            
            // Bildirim göster
            showSuccess('Çalma listesi yenileniyor...');
            
            // 1 saniye sonra animasyonu durdur
            setTimeout(() => {
                refreshButton.classList.remove('fa-spin');
            }, 1000);
        }

        // Audio player hata yönetimi
        audioPlayer.addEventListener('error', (e) => {
            let errorMessage = 'Bilinmeyen bir hata oluştu';
            if (e.target.error) {
                switch (e.target.error.code) {
                    case e.target.error.MEDIA_ERR_ABORTED:
                        errorMessage = 'Şarkı yüklemesi iptal edildi';
                        break;
                    case e.target.error.MEDIA_ERR_NETWORK:
                        errorMessage = 'Ağ hatası oluştu';
                        break;
                    case e.target.error.MEDIA_ERR_DECODE:
                        errorMessage = 'Şarkı çözümlenemedi';
                        break;
                    case e.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                        errorMessage = 'Bu ses formatı desteklenmiyor';
                        break;
                }
            }
            showError(errorMessage);
        });

        // Oynatma durumu değişikliklerini izle
        audioPlayer.addEventListener('play', () => {
            if (!isPlaying) {
                playMusic();
                startSyncInterval();
            }
        });

        audioPlayer.addEventListener('pause', () => {
            if (isPlaying) {
                pauseMusic();
                stopSyncInterval();
            }
        });
        
        // Şarkı ileri/geri sarıldığında senkronize et
        audioPlayer.addEventListener('seeked', () => {
            if (isPlaying) {
                playMusic(); // Yeni pozisyonu sunucuya bildir
            }
        });

        // Şarkı bittiğinde sonraki şarkıya geç
        audioPlayer.addEventListener('ended', () => {
            const nextTrack = currentTrack + 1;
            if (nextTrack < currentPlaylist.length) {
                playSong(nextTrack);
            } else if (currentPlaylist.length > 0) {
                // Çalma listesi bitti, başa dön
                playSong(0);
                showSuccess('Çalma listesi başa döndü');
            } else {
                // Çalma listesi boş
                isPlaying = false;
                updatePlaylistUI();
                showSuccess('Çalma listesi tamamlandı');
            }
        });

        // Sayfa kapatılırken veya yenilenirken oturum bilgisini güncelle
        window.addEventListener('beforeunload', function() {
            if (roomId && username) {
                saveSession();
            }
        });

        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', function() {
            // İlerleme çubuğu için event listener'ları ekle
            setupProgressBar();
            
            // Audio player için event listener'lar
            audioPlayer.addEventListener('timeupdate', updateProgressBar);
            
            // Bağlantı durumunu izle
            socket.on('connect', () => {
                console.log('Socket.IO bağlantısı kuruldu');
                
                // Bağlantı kurulduğunda, eğer oturum bilgisi varsa otomatik giriş yap
                restoreSession();
            });
        });

        // Initialize the audio visualizer
        function initVisualizer() {
            const visualizer = document.getElementById('audio-visualizer');
            visualizer.innerHTML = '';
            
            // Create 30 bars for the visualizer
            for (let i = 0; i < 30; i++) {
                const bar = document.createElement('div');
                bar.className = 'visualizer-bar';
                visualizer.appendChild(bar);
            }
        }

        // Update the visualizer based on audio playback
        function updateVisualizer() {
            if (!isPlaying) return;
            
            const bars = document.querySelectorAll('.visualizer-bar');
            bars.forEach(bar => {
                const height = Math.floor(Math.random() * 50) + 5;
                bar.style.height = `${height}px`;
            });
        }

        // Update the UI to reflect the current song
        function updateCurrentSongUI(song, index) {
            if (!song) {
                document.getElementById('current-song-title').textContent = 'Şarkı Seçilmedi';
                document.getElementById('current-song-artist').textContent = 'Sanatçı';
                document.getElementById('albumCover').src = 'https://via.placeholder.com/300';
                return;
            }

            document.getElementById('current-song-title').textContent = song.name || 'Bilinmeyen Şarkı';
            document.getElementById('current-song-artist').textContent = song.addedBy || 'Bilinmeyen Sanatçı';
            
            // Set a default album cover or generate one based on the song name
            document.getElementById('albumCover').src = `https://picsum.photos/seed/${encodeURIComponent(song.name)}/300/300`;
            
            // Update the active song in the playlist
            const playlistItems = document.querySelectorAll('.playlist-item');
            playlistItems.forEach((item, i) => {
                if (i === index) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // Render the playlist
        function renderPlaylist(songs) {
            const playlistElement = document.getElementById('playlist');
            playlistElement.innerHTML = '';

            if (!songs || songs.length === 0) {
                playlistElement.innerHTML = '<div class="no-songs">Henüz şarkı eklenmemiş</div>';
                return;
            }

            songs.forEach((song, index) => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                if (index === currentTrack) {
                    item.classList.add('active');
                }

                // Format the duration if available
                let duration = '0:00';
                if (song.duration) {
                    const minutes = Math.floor(song.duration / 60);
                    const seconds = Math.floor(song.duration % 60).toString().padStart(2, '0');
                    duration = `${minutes}:${seconds}`;
                }

                item.innerHTML = `
                    <div class="playlist-item-number">${index + 1}</div>
                    <div class="playlist-item-info">
                        <div class="playlist-item-title">${song.name || 'Bilinmeyen Şarkı'}</div>
                        <div class="playlist-item-artist">${song.addedBy || 'Bilinmeyen Sanatçı'}</div>
                    </div>
                    <div class="playlist-item-duration">${duration}</div>
                `;

                item.addEventListener('click', () => {
                    playSong(index);
                });

                playlistElement.appendChild(item);
            });
        }

        // Update the room users display
        function updateRoomUsers(users) {
            const roomUsersElement = document.getElementById('room-users');
            roomUsersElement.innerHTML = '';

            if (!users || users.length === 0) {
                return;
            }

            users.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'room-user';
                userElement.innerHTML = `
                    <i class="fas fa-user"></i>
                    <span>${user}</span>
                `;
                roomUsersElement.appendChild(userElement);
            });
        }

        // Format time in seconds to MM:SS format
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return '0:00';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${minutes}:${remainingSeconds}`;
        }

        // Update the progress bar and time display
        function updateProgress() {
            const player = document.getElementById('audioPlayer');
            const progressBar = document.getElementById('progressBar');
            const currentTimeElement = document.getElementById('currentTime');
            const totalTimeElement = document.getElementById('totalTime');

            if (player.duration) {
                const progress = (player.currentTime / player.duration) * 100;
                progressBar.style.width = `${progress}%`;
                currentTimeElement.textContent = formatTime(player.currentTime);
                totalTimeElement.textContent = formatTime(player.duration);
            } else {
                progressBar.style.width = '0%';
                currentTimeElement.textContent = '0:00';
                totalTimeElement.textContent = '0:00';
            }
        }

        // Initialize the UI
        function initUI() {
            // Initialize the visualizer
            initVisualizer();
            
            // Set up the progress bar click handler
            document.getElementById('progressContainer').addEventListener('click', function(e) {
                const player = document.getElementById('audioPlayer');
                if (player.duration) {
                    const percent = e.offsetX / this.offsetWidth;
                    player.currentTime = percent * player.duration;
                    updateProgress();
                }
            });

            // Set up the volume slider
            document.getElementById('volume-slider').addEventListener('input', function() {
                const player = document.getElementById('audioPlayer');
                player.volume = this.value / 100;
                
                // Update the volume icon
                const volumeIcon = document.getElementById('volume-icon');
                if (player.volume === 0) {
                    volumeIcon.className = 'fas fa-volume-mute';
                } else if (player.volume < 0.5) {
                    volumeIcon.className = 'fas fa-volume-down';
                } else {
                    volumeIcon.className = 'fas fa-volume-up';
                }
            });

            // Set up the play/pause button
            document.getElementById('play-pause-button').addEventListener('click', function() {
                togglePlay();
            });

            // Set up the next button
            document.getElementById('next-button').addEventListener('click', function() {
                playNextSong();
            });

            // Set up the previous button
            document.getElementById('prev-button').addEventListener('click', function() {
                playPreviousSong();
            });

            // Set up the add song button
            document.getElementById('add-song-button').addEventListener('click', function() {
                document.getElementById('file-input').click();
            });

            // Set up the delete room button
            document.getElementById('delete-room-button').addEventListener('click', function() {
                if (confirm('Bu odayı silmek istediğinize emin misiniz?')) {
                    deleteRoom();
                }
            });

            // Set up the audio player events
            const player = document.getElementById('audioPlayer');
            player.addEventListener('timeupdate', updateProgress);
            player.addEventListener('ended', playNextSong);
            
            // Start the visualizer animation
            setInterval(updateVisualizer, 100);

            // Set the user avatar initial
            const userAvatar = document.getElementById('user-avatar');
            if (username) {
                userAvatar.textContent = username.charAt(0).toUpperCase();
                document.getElementById('username-display').textContent = username;
            }
        }

        // Show the player interface
        function showPlayerInterface() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('player-container').style.display = 'flex';
            document.getElementById('playlist-container').style.display = 'block';
            document.getElementById('room-info').style.display = 'block';
            document.getElementById('room-id-display').textContent = roomId;
            
            // Check if mobile view
            if (window.innerWidth <= 768) {
                document.getElementById('mobile-nav').style.display = 'flex';
                // Initially show only player tab on mobile
                showPlayerTab();
            }
            
            // Initialize the UI
            initUI();
        }

        // Mobile navigation functions
        function showPlayerTab() {
            if (window.innerWidth <= 768) {
                document.getElementById('player-container').style.display = 'flex';
                document.getElementById('playlist-container').style.display = 'none';
                document.getElementById('userSection').style.display = 'none';
                
                // Update active tab
                const navButtons = document.querySelectorAll('.mobile-nav-button');
                navButtons.forEach(btn => btn.classList.remove('active'));
                document.querySelector('.mobile-nav-button:nth-child(1)').classList.add('active');
            }
        }
        
        function showPlaylistTab() {
            if (window.innerWidth <= 768) {
                document.getElementById('player-container').style.display = 'none';
                document.getElementById('playlist-container').style.display = 'block';
                document.getElementById('userSection').style.display = 'none';
                
                // Update active tab
                const navButtons = document.querySelectorAll('.mobile-nav-button');
                navButtons.forEach(btn => btn.classList.remove('active'));
                document.querySelector('.mobile-nav-button:nth-child(2)').classList.add('active');
            }
        }
        
        function showUsersTab() {
            if (window.innerWidth <= 768) {
                document.getElementById('player-container').style.display = 'none';
                document.getElementById('playlist-container').style.display = 'none';
                document.getElementById('userSection').style.display = 'block';
                
                // Update active tab
                const navButtons = document.querySelectorAll('.mobile-nav-button');
                navButtons.forEach(btn => btn.classList.remove('active'));
                document.querySelector('.mobile-nav-button:nth-child(3)').classList.add('active');
            }
        }
        
        function showSettingsTab() {
            if (window.innerWidth <= 768) {
                // Show room settings or link sharing options
                document.getElementById('roomLinkSection').style.display = 'block';
                
                // Update active tab
                const navButtons = document.querySelectorAll('.mobile-nav-button');
                navButtons.forEach(btn => btn.classList.remove('active'));
                document.querySelector('.mobile-nav-button:nth-child(4)').classList.add('active');
                
                // Show a modal with settings
                showRoomSettings();
            }
        }
        
        // Show room settings modal
        function showRoomSettings() {
            // Create a modal for room settings
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'settings-modal';
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-4 w-5/6 max-w-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Oda Ayarları</h3>
                        <button onclick="closeSettingsModal()" class="text-gray-500">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-2">Oda Linki:</p>
                        <div class="flex">
                            <input type="text" value="${window.location.href}" readonly class="flex-1 p-2 bg-gray-100 rounded-l-lg text-sm">
                            <button onclick="copyLink()" class="bg-gray-800 text-white px-3 rounded-r-lg">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2">
                        <button onclick="shareLink()" class="bg-indigo-600 text-white py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                            <i class="fas fa-share-alt"></i> Odayı Paylaş
                        </button>
                        <button onclick="confirmDeleteRoom()" class="bg-red-600 text-white py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                            <i class="fas fa-trash-alt"></i> Odayı Sil
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeSettingsModal();
                }
            });
        }
        
        // Close settings modal
        function closeSettingsModal() {
            const modal = document.getElementById('settings-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 768) {
                // Mobile view
                document.getElementById('mobile-nav').style.display = 'flex';
                // Make sure at least one tab is visible
                if (document.getElementById('player-container').style.display === 'none' && 
                    document.getElementById('playlist-container').style.display === 'none' && 
                    document.getElementById('userSection').style.display === 'none') {
                    showPlayerTab();
                }
            } else {
                // Desktop view
                document.getElementById('mobile-nav').style.display = 'none';
                // Show all sections
                document.getElementById('player-container').style.display = 'flex';
                document.getElementById('playlist-container').style.display = 'block';
                document.getElementById('userSection').style.display = 'block';
            }
        });
    </script>
</body>
</html>
